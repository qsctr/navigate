'use strict';
const uniformCostSearch = (start, goal) => bestFirstSearch(start, goal, ({ pathDistance }) => pathDistance);
const greedySearch = (start, goal) => bestFirstSearch(start, goal, ({ node }) => distanceBetween(node, goal));
const aStarSearch = (start, goal) => bestFirstSearch(start, goal, ({ node, pathDistance }) => pathDistance + distanceBetween(node, goal));
function bestFirstSearch(start, goal, scoreFunc) {
    const expanded = [];
    const pathDistances = new Map([[start.id, 0]]);
    const scores = new Map([[start.id, scoreFunc({
                node: start,
                pathDistance: 0
            })]]);
    const parents = new Map();
    const fringe = new PriorityQueue({
        comparator: (a, b) => scores.get(a.id) - scores.get(b.id),
        initialValues: [start]
    });
    while (fringe.length > 0) {
        const current = fringe.dequeue();
        if (expanded.includes(current)) {
            continue;
        }
        expanded.push(current);
        const currentPathDistance = pathDistances.get(current.id);
        if (current === goal) {
            const path = [goal];
            let parent = goal;
            while (parent !== start) {
                parent = parents.get(parent.id);
                path.unshift(parent);
            }
            return { expanded, path, fringe };
        }
        for (const { distance, child } of current.connections) {
            if (expanded.includes(child)) {
                continue;
            }
            const oldChildScore = scores.get(child.id);
            const newChildScore = scoreFunc({
                node: child,
                pathDistance: currentPathDistance + distance
            });
            if (oldChildScore === undefined || newChildScore < oldChildScore) {
                pathDistances.set(child.id, currentPathDistance + distance);
                scores.set(child.id, newChildScore);
                parents.set(child.id, current);
                fringe.queue(child);
            }
        }
    }
    return { expanded };
}
function distanceBetween(a, b) {
    return Math.sqrt(Math.pow(a.lat - b.lat, 2) + Math.pow(a.lng - b.lng, 2));
}
function overpassToGraphNodes({ elements }) {
    const graphNodes = [];
    for (const { nodes, geometry, tags: { junction } } of elements) {
        let prevGraphNode;
        let firstGraphNode;
        nodes.forEach((nodeId, i) => {
            let graphNode = graphNodes.find(graphNode => graphNode.id === nodeId);
            if (graphNode === undefined) {
                graphNode = {
                    id: nodeId,
                    lat: geometry[i].lat,
                    lng: geometry[i].lon,
                    connections: []
                };
                graphNodes.push(graphNode);
            }
            if (i === 0) {
                firstGraphNode = graphNode;
            }
            else {
                connect(graphNode, prevGraphNode);
            }
            if (i === nodes.length - 1 && junction === 'roundabout') {
                connect(graphNode, firstGraphNode);
            }
            prevGraphNode = graphNode;
        });
    }
    return graphNodes;
    function connect(a, b) {
        const distance = distanceBetween(a, b);
        a.connections.push({ distance, child: b });
        b.connections.push({ distance, child: a });
    }
}
onerror = alert;
(() => {
    const qs = document.querySelector.bind(document);
    const qsa = document.querySelectorAll.bind(document);
    const introScreen = qs('#intro-screen');
    const queryButton = qs('#query-button');
    const areaTooBig = qs('#area-too-big-warning');
    const queryingScreen = qs('#querying-screen');
    const chooseScreen = qs('#choose-screen');
    const nodesCreatedElem = qs('#nodes-created');
    const startNodeIdElem = qs('#start-node-id');
    const goalNodeIdElem = qs('#goal-node-id');
    const searchButton = qs('#search-button');
    const resultsScreen = qs('#results-screen');
    const pathResult = qs('#path-result');
    const expandedResult = qs('#expanded-result');
    const fringeResult = qs('#fringe-result');
    const backButton = qs('#back-button');
    const sidebarItems = Array.prototype.slice.call(qsa('#sidebar > *'));
    const colors = {
        default: '#3388ff',
        start: 'red',
        goal: 'green',
        expanded: 'darkblue',
        path: '#009688',
        fringe: 'orange'
    };
    let map;
    let startNode = null;
    let goalNode = null;
    let searchFunction;
    queryButton.addEventListener('click', query);
    searchButton.addEventListener('click', search);
    const radioToFunction = {
        'uniform-cost-radio': uniformCostSearch,
        'greedy-radio': greedySearch,
        'a-star-radio': aStarSearch
    };
    for (const id in radioToFunction) {
        document.querySelector('#' + id).addEventListener('click', () => {
            searchFunction = radioToFunction[id];
            checkSearchButton();
        });
    }
    backButton.addEventListener('click', chooseAgain);
    const nodeIdToCircle = new Map();
    let pathLine = null;
    navigator.geolocation.getCurrentPosition(pos => init(pos.coords.latitude, pos.coords.longitude), () => init(25.116035, 121.529946) // fallback to TAS
    );
    function init(lat, lng) {
        map = L.map('map', {
            center: [lat, lng],
            zoom: 17,
            worldCopyJump: true
        });
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 21,
            maxNativeZoom: 19
        }).addTo(map);
        map.on('zoom', () => {
            if (map.getZoom() < 13) {
                queryButton.disabled = true;
                showElem(areaTooBig);
            }
            else {
                queryButton.disabled = false;
                hideElem(areaTooBig);
            }
        });
        showOnly(introScreen);
    }
    function query() {
        showOnly(queryingScreen);
        const bounds = map.getBounds();
        const overpassQL = `[out:json];way[highway](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});out geom;`;
        fetch('https://overpass-api.de/api/interpreter?data=' + overpassQL)
            .then(res => res.json())
            .then(createNodes);
    }
    function createNodes(data) {
        const nodes = overpassToGraphNodes(data);
        for (const node of nodes) {
            const circle = L.circle(node, {
                radius: 6,
                stroke: false,
                fillOpacity: 0.7,
                color: colors.default
            }).bindPopup(() => {
                const elem = document.createElement('div');
                const id = document.createElement('div');
                id.textContent = node.id.toString();
                elem.appendChild(id);
                const startLink = document.createElement('a');
                startLink.href = '#';
                startLink.textContent = 'Set as start';
                startLink.addEventListener('click', () => {
                    if (node === goalNode) {
                        goalNode = null;
                        goalNodeIdElem.textContent = '';
                        nodeIdToCircle.get(node.id).setStyle({
                            color: colors.default
                        });
                    }
                    if (startNode !== null) {
                        nodeIdToCircle.get(startNode.id).setStyle({
                            color: colors.default
                        });
                    }
                    startNode = node;
                    startNodeIdElem.textContent = startNode.id.toString();
                    checkSearchButton();
                    circle.closePopup();
                    circle.setStyle({
                        color: colors.start
                    });
                });
                elem.appendChild(startLink);
                elem.appendChild(document.createElement('br'));
                const goalLink = document.createElement('a');
                goalLink.href = '#';
                goalLink.textContent = 'Set as goal';
                goalLink.addEventListener('click', () => {
                    if (node === startNode) {
                        startNode = null;
                        startNodeIdElem.textContent = '';
                        nodeIdToCircle.get(node.id).setStyle({
                            color: colors.default
                        });
                    }
                    if (goalNode !== null) {
                        nodeIdToCircle.get(goalNode.id).setStyle({
                            color: colors.default
                        });
                    }
                    goalNode = node;
                    goalNodeIdElem.textContent = goalNode.id.toString();
                    checkSearchButton();
                    circle.closePopup();
                    circle.setStyle({
                        color: colors.goal
                    });
                });
                elem.appendChild(goalLink);
                return elem;
            }).addTo(map);
            nodeIdToCircle.set(node.id, circle);
        }
        nodesCreatedElem.textContent = nodes.length.toString();
        showOnly(chooseScreen);
    }
    function search() {
        const { expanded, path, fringe } = searchFunction(startNode, goalNode);
        expandedResult.textContent = expanded.length.toString();
        for (const exp of expanded) {
            if (exp !== startNode && exp !== goalNode) {
                nodeIdToCircle.get(exp.id).setStyle({
                    color: colors.expanded
                });
            }
        }
        if (path === undefined) {
            pathResult.textContent = 'Path not found.';
        }
        else {
            pathResult.textContent = `Path found with ${path.length} nodes.`;
            pathLine = L.polyline(path, {
                weight: 8,
                color: colors.path
            }).addTo(map);
        }
        if (fringe === undefined) {
            fringeResult.textContent = 'No';
        }
        else {
            fringeResult.textContent = fringe.length.toString();
            while (fringe.length > 0) {
                nodeIdToCircle.get(fringe.dequeue().id).setStyle({
                    color: colors.fringe
                });
            }
        }
        showOnly(resultsScreen);
    }
    function chooseAgain() {
        for (const [id, circle] of nodeIdToCircle.entries()) {
            if (id !== startNode.id && id !== goalNode.id) {
                circle.setStyle({
                    color: colors.default
                });
            }
        }
        if (pathLine !== null) {
            pathLine.remove();
            pathLine = null;
        }
        showOnly(chooseScreen);
    }
    function checkSearchButton() {
        searchButton.disabled = !(startNode && goalNode && searchFunction);
    }
    function showOnly(elem) {
        for (const item of sidebarItems) {
            hideElem(item);
        }
        showElem(elem);
    }
    function showElem(elem) {
        elem.style.display = 'block';
    }
    function hideElem(elem) {
        elem.style.display = 'none';
    }
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjLXRzL3NlYXJjaC50cyIsIi4uL3NyYy10cy91aS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUE0Q2IsTUFBTSxpQkFBaUIsR0FBbUIsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FDdEQsZUFBZSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQUUsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUVyRSxNQUFNLFlBQVksR0FBbUIsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FDakQsZUFBZSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7QUFFNUUsTUFBTSxXQUFXLEdBQW1CLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFLENBQ2hELGVBQWUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLEVBQUUsRUFBRSxDQUNwRCxZQUFZLEdBQUcsZUFBZSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBRXBELFNBQVMsZUFBZSxDQUFDLEtBQWdCLEVBQUUsSUFBZSxFQUMxRCxTQUEwQjtJQUN0QixNQUFNLFFBQVEsR0FBZ0IsRUFBRSxDQUFDO0lBQ2pDLE1BQU0sYUFBYSxHQUFHLElBQUksR0FBRyxDQUFlLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM3RCxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBWSxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUM7Z0JBQ3BELElBQUksRUFBRSxLQUFLO2dCQUNYLFlB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Q0QsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFFRCxTQUFTLFFBQVEsQ0FBQyxJQUFpQjtRQUMvQixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDakMsQ0FBQztJQUVELFNBQVMsUUFBUSxDQUFDLElBQWlCO1FBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUNoQyxDQUFDO0FBRUwsQ0FBQyxDQUFDLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudHlwZSBJZCA9IG51bWJlcjtcbnR5cGUgU2NvcmUgPSBudW1iZXI7XG50eXBlIERpc3RhbmNlID0gbnVtYmVyO1xuXG5pbnRlcmZhY2UgR3JhcGhOb2RlIHtcbiAgICByZWFkb25seSBsYXQ6IG51bWJlcjtcbiAgICByZWFkb25seSBsbmc6IG51bWJlcjtcbiAgICByZWFkb25seSBpZDogSWQ7XG4gICAgcmVhZG9ubHkgY29ubmVjdGlvbnM6IENvbm5lY3Rpb25bXTtcbn1cblxuaW50ZXJmYWNlIENvbm5lY3Rpb24geyAvLyBcIkFkamFjZW5jeVwiIGlzIHRvbyBoYXJkIHRvIHNwZWxsXG4gICAgcmVhZG9ubHkgZGlzdGFuY2U6IERpc3RhbmNlO1xuICAgIHJlYWRvbmx5IGNoaWxkOiBHcmFwaE5vZGU7XG59XG5cbnR5cGUgU2NvcmluZ0Z1bmN0aW9uID0gKGluZm86IHtcbiAgICBub2RlOiBHcmFwaE5vZGVcbiAgICBwYXRoRGlzdGFuY2U6IERpc3RhbmNlO1xufSkgPT4gU2NvcmU7XG5cbmludGVyZmFjZSBPdmVycGFzc0pTT04ge1xuICAgIGVsZW1lbnRzOiB7XG4gICAgICAgIG5vZGVzOiBudW1iZXJbXTtcbiAgICAgICAgZ2VvbWV0cnk6IHtcbiAgICAgICAgICAgIGxhdDogbnVtYmVyO1xuICAgICAgICAgICAgbG9uOiBudW1iZXI7XG4gICAgICAgIH1bXTtcbiAgICAgICAgdGFnczoge1xuICAgICAgICAgICAganVuY3Rpb246IHN0cmluZ1xuICAgICAgICB9O1xuICAgIH1bXTtcbn1cblxudHlwZSBTZWFyY2hGdW5jdGlvbiA9IChzdGFydDogR3JhcGhOb2RlLCBnb2FsOiBHcmFwaE5vZGUpID0+IFNlYXJjaFJlc3VsdDtcblxudHlwZSBTZWFyY2hSZXN1bHQgPSB7XG4gICAgZXhwYW5kZWQ6IEdyYXBoTm9kZVtdLFxuICAgIHBhdGg/OiBHcmFwaE5vZGVbXSxcbiAgICBmcmluZ2U/OiBQcmlvcml0eVF1ZXVlPEdyYXBoTm9kZT5cbn07XG5cbmNvbnN0IHVuaWZvcm1Db3N0U2VhcmNoOiBTZWFyY2hGdW5jdGlvbiA9IChzdGFydCwgZ29hbCkgPT5cbiAgICBiZXN0Rmlyc3RTZWFyY2goc3RhcnQsIGdvYWwsICh7IHBhdGhEaXN0YW5jZSB9KSA9PiBwYXRoRGlzdGFuY2UpO1xuXG5jb25zdCBncmVlZHlTZWFyY2g6IFNlYXJjaEZ1bmN0aW9uID0gKHN0YXJ0LCBnb2FsKSA9PlxuICAgIGJlc3RGaXJzdFNlYXJjaChzdGFydCwgZ29hbCwgKHsgbm9kZSB9KSA9PiBkaXN0YW5jZUJldHdlZW4obm9kZSwgZ29hbCkpO1xuXG5jb25zdCBhU3RhclNlYXJjaDogU2VhcmNoRnVuY3Rpb24gPSAoc3RhcnQsIGdvYWwpID0+XG4gICAgYmVzdEZpcnN0U2VhcmNoKHN0YXJ0LCBnb2FsLCAoeyBub2RlLCBwYXRoRGlzdGFuY2UgfSkgPT5cbiAgICAgICAgcGF0aERpc3RhbmNlICsgZGlzdGFuY2VCZXR3ZWVuKG5vZGUsIGdvYWwpKTtcblxuZnVuY3Rpb24gYmVzdEZpcnN0U2VhcmNoKHN0YXJ0OiBHcmFwaE5vZGUsIGdvYWw6IEdyYXBoTm9kZSxcbnNjb3JlRnVuYzogU2NvcmluZ0Z1bmN0aW9uKTogU2VhcmNoUmVzdWx0IHtcbiAgICBjb25zdCBleHBhbmRlZDogR3JhcGhOb2RlW10gPSBbXTtcbiAgICBjb25zdCBwYXRoRGlzdGFuY2VzID0gbmV3IE1hcDxJZCwgRGlzdGFuY2U+KFtbc3RhcnQuaWQsIDBdXSk7XG4gICAgY29uc3Qgc2NvcmVzID0gbmV3IE1hcDxJZCwgU2NvcmU+KFtbc3RhcnQuaWQsIHNjb3JlRnVuYyh7XG4gICAgICAgIG5vZGU6IHN0YXJ0LFxuICAgICAgICBwYXRoRGlzdGFuY2U6IDBcbiAgICB9KV1dKTtcbiAgICBjb25zdCBwYXJlbnRzID0gbmV3IE1hcDxJZCwgR3JhcGhOb2RlPigpO1xuICAgIGNvbnN0IGZyaW5nZSA9IG5ldyBQcmlvcml0eVF1ZXVlPEdyYXBoTm9kZT4oe1xuICAgICAgICBjb21wYXJhdG9yOiAoYTogR3JhcGhOb2RlLCBiOiBHcmFwaE5vZGUpID0+XG4gICAgICAgICAgICAoc2NvcmVzLmdldChhLmlkKSBhcyBTY29yZSkgLSAoc2NvcmVzLmdldChiLmlkKSBhcyBTY29yZSksXG4gICAgICAgIGluaXRpYWxWYWx1ZXM6IFtzdGFydF1cbiAgICB9KTtcbiAgICB3aGlsZSAoZnJpbmdlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgY3VycmVudCA9IGZyaW5nZS5kZXF1ZXVlKCk7XG4gICAgICAgIGlmIChleHBhbmRlZC5pbmNsdWRlcyhjdXJyZW50KSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgZXhwYW5kZWQucHVzaChjdXJyZW50KTtcbiAgICAgICAgY29uc3QgY3VycmVudFBhdGhEaXN0YW5jZSA9IHBhdGhEaXN0YW5jZXMuZ2V0KGN1cnJlbnQuaWQpIGFzIERpc3RhbmNlO1xuICAgICAgICBpZiAoY3VycmVudCA9PT0gZ29hbCkge1xuICAgICAgICAgICAgY29uc3QgcGF0aCA9IFtnb2FsXTtcbiAgICAgICAgICAgIGxldCBwYXJlbnQgPSBnb2FsO1xuICAgICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gc3RhcnQpIHtcbiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnRzLmdldChwYXJlbnQuaWQpIGFzIEdyYXBoTm9kZTtcbiAgICAgICAgICAgICAgICBwYXRoLnVuc2hpZnQocGFyZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB7IGV4cGFuZGVkLCBwYXRoLCBmcmluZ2UgfTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IHsgZGlzdGFuY2UsIGNoaWxkIH0gb2YgY3VycmVudC5jb25uZWN0aW9ucykge1xuICAgICAgICAgICAgaWYgKGV4cGFuZGVkLmluY2x1ZGVzKGNoaWxkKSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgb2xkQ2hpbGRTY29yZSA9IHNjb3Jlcy5nZXQoY2hpbGQuaWQpO1xuICAgICAgICAgICAgY29uc3QgbmV3Q2hpbGRTY29yZSA9IHNjb3JlRnVuYyh7XG4gICAgICAgICAgICAgICAgbm9kZTogY2hpbGQsXG4gICAgICAgICAgICAgICAgcGF0aERpc3RhbmNlOiBjdXJyZW50UGF0aERpc3RhbmNlICsgZGlzdGFuY2VcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKG9sZENoaWxkU2NvcmUgPT09IHVuZGVmaW5lZCB8fCBuZXdDaGlsZFNjb3JlIDwgb2xkQ2hpbGRTY29yZSkge1xuICAgICAgICAgICAgICAgIHBhdGhEaXN0YW5jZXMuc2V0KGNoaWxkLmlkLCBjdXJyZW50UGF0aERpc3RhbmNlICsgZGlzdGFuY2UpO1xuICAgICAgICAgICAgICAgIHNjb3Jlcy5zZXQoY2hpbGQuaWQsIG5ld0NoaWxkU2NvcmUpO1xuICAgICAgICAgICAgICAgIHBhcmVudHMuc2V0KGNoaWxkLmlkLCBjdXJyZW50KTtcbiAgICAgICAgICAgICAgICBmcmluZ2UucXVldWUoY2hpbGQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7IGV4cGFuZGVkIH07XG59XG5cbmZ1bmN0aW9uIGRpc3RhbmNlQmV0d2VlbihhOiBHcmFwaE5vZGUsIGI6IEdyYXBoTm9kZSkge1xuICAgIHJldHVybiBNYXRoLnNxcnQoTWF0aC5wb3coYS5sYXQgLSBiLmxhdCwgMikgKyBNYXRoLnBvdyhhLmxuZyAtIGIubG5nLCAyKSk7XG59XG5cbmZ1bmN0aW9uIG92ZXJwYXNzVG9HcmFwaE5vZGVzKHsgZWxlbWVudHMgfTogT3ZlcnBhc3NKU09OKSB7XG4gICAgY29uc3QgZ3JhcGhOb2RlczogR3JhcGhOb2RlW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHsgbm9kZXMsIGdlb21ldHJ5LCB0YWdzOiB7IGp1bmN0aW9uIH0gfSBvZiBlbGVtZW50cykge1xuICAgICAgICBsZXQgcHJldkdyYXBoTm9kZTogR3JhcGhOb2RlO1xuICAgICAgICBsZXQgZmlyc3RHcmFwaE5vZGU6IEdyYXBoTm9kZTtcbiAgICAgICAgbm9kZXMuZm9yRWFjaCgobm9kZUlkLCBpKSA9PiB7XG4gICAgICAgICAgICBsZXQgZ3JhcGhOb2RlID0gZ3JhcGhOb2Rlcy5maW5kKGdyYXBoTm9kZSA9PiBncmFwaE5vZGUuaWQgPT09IG5vZGVJZCk7XG4gICAgICAgICAgICBpZiAoZ3JhcGhOb2RlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBncmFwaE5vZGUgPSB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBub2RlSWQsXG4gICAgICAgICAgICAgICAgICAgIGxhdDogZ2VvbWV0cnlbaV0ubGF0LFxuICAgICAgICAgICAgICAgICAgICBsbmc6IGdlb21ldHJ5W2ldLmxvbixcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbnM6IFtdIGFzIENvbm5lY3Rpb25bXVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgZ3JhcGhOb2Rlcy5wdXNoKGdyYXBoTm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGZpcnN0R3JhcGhOb2RlID0gZ3JhcGhOb2RlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25uZWN0KGdyYXBoTm9kZSwgcHJldkdyYXBoTm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaSA9PT0gbm9kZXMubGVuZ3RoIC0gMSAmJiBqdW5jdGlvbiA9PT0gJ3JvdW5kYWJvdXQnKSB7XG4gICAgICAgICAgICAgICAgY29ubmVjdChncmFwaE5vZGUsIGZpcnN0R3JhcGhOb2RlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHByZXZHcmFwaE5vZGUgPSBncmFwaE5vZGU7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gZ3JhcGhOb2RlcztcbiAgICBmdW5jdGlvbiBjb25uZWN0KGE6IEdyYXBoTm9kZSwgYjogR3JhcGhOb2RlKSB7XG4gICAgICAgIGNvbnN0IGRpc3RhbmNlID0gZGlzdGFuY2VCZXR3ZWVuKGEsIGIpO1xuICAgICAgICBhLmNvbm5lY3Rpb25zLnB1c2goeyBkaXN0YW5jZSwgY2hpbGQ6IGIgfSk7XG4gICAgICAgIGIuY29ubmVjdGlvbnMucHVzaCh7IGRpc3RhbmNlLCBjaGlsZDogYSB9KTtcbiAgICB9XG59IiwiJ3VzZSBzdHJpY3QnO1xuXG5vbmVycm9yID0gYWxlcnQ7XG5cbigoKSA9PiB7XG5cbiAgICBjb25zdCBxczogdHlwZW9mIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yLmJpbmQoZG9jdW1lbnQpO1xuICAgIGNvbnN0IHFzYTogdHlwZW9mIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsLmJpbmQoZG9jdW1lbnQpO1xuXG4gICAgY29uc3QgaW50cm9TY3JlZW4gPSBxcygnI2ludHJvLXNjcmVlbicpIGFzIEhUTUxFbGVtZW50O1xuICAgIGNvbnN0IHF1ZXJ5QnV0dG9uID0gcXMoJyNxdWVyeS1idXR0b24nKSBhcyBIVE1MQnV0dG9uRWxlbWVudDtcbiAgICBjb25zdCBhcmVhVG9vQmlnID0gcXMoJyNhcmVhLXRvby1iaWctd2FybmluZycpIGFzIEhUTUxFbGVtZW50O1xuICAgIGNvbnN0IHF1ZXJ5aW5nU2NyZWVuID0gcXMoJyNxdWVyeWluZy1zY3JlZW4nKSBhcyBIVE1MRWxlbWVudDtcbiAgICBjb25zdCBjaG9vc2VTY3JlZW4gPSBxcygnI2Nob29zZS1zY3JlZW4nKSBhcyBIVE1MRWxlbWVudDtcbiAgICBjb25zdCBub2Rlc0NyZWF0ZWRFbGVtID0gcXMoJyNub2Rlcy1jcmVhdGVkJyk7XG4gICAgY29uc3Qgc3RhcnROb2RlSWRFbGVtID0gcXMoJyNzdGFydC1ub2RlLWlkJyk7XG4gICAgY29uc3QgZ29hbE5vZGVJZEVsZW0gPSBxcygnI2dvYWwtbm9kZS1pZCcpO1xuICAgIGNvbnN0IHNlYXJjaEJ1dHRvbiA9IHFzKCcjc2VhcmNoLWJ1dHRvbicpIGFzIEhUTUxCdXR0b25FbGVtZW50O1xuICAgIGNvbnN0IHJlc3VsdHNTY3JlZW4gPSBxcygnI3Jlc3VsdHMtc2NyZWVuJykgYXMgSFRNTEVsZW1lbnQ7XG4gICAgY29uc3QgcGF0aFJlc3VsdCA9IHFzKCcjcGF0aC1yZXN1bHQnKTtcbiAgICBjb25zdCBleHBhbmRlZFJlc3VsdCA9IHFzKCcjZXhwYW5kZWQtcmVzdWx0Jyk7XG4gICAgY29uc3QgZnJpbmdlUmVzdWx0ID0gcXMoJyNmcmluZ2UtcmVzdWx0Jyk7XG4gICAgY29uc3QgYmFja0J1dHRvbiA9IHFzKCcjYmFjay1idXR0b24nKSBhcyBIVE1MQnV0dG9uRWxlbWVudDtcblxuICAgIGNvbnN0IHNpZGViYXJJdGVtcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHFzYSgnI3NpZGViYXIgPiAqJykpIGFzIEhUTUxFbGVtZW50W107XG5cbiAgICBjb25zdCBjb2xvcnMgPSB7XG4gICAgICAgIGRlZmF1bHQ6ICcjMzM4OGZmJyxcbiAgICAgICAgc3RhcnQ6ICdyZWQnLFxuICAgICAgICBnb2FsOiAnZ3JlZW4nLFxuICAgICAgICBleHBhbmRlZDogJ2RhcmtibHVlJyxcbiAgICAgICAgcGF0aDogJyMwMDk2ODgnLFxuICAgICAgICBmcmluZ2U6ICdvcmFuZ2UnXG4gICAgfTtcblxuICAgIGxldCBtYXA6IEwuTWFwO1xuXG4gICAgbGV0IHN0YXJ0Tm9kZTogR3JhcGhOb2RlIHwgbnVsbCA9IG51bGw7XG4gICAgbGV0IGdvYWxOb2RlOiBHcmFwaE5vZGUgfCBudWxsID0gbnVsbDtcbiAgICBsZXQgc2VhcmNoRnVuY3Rpb246IFNlYXJjaEZ1bmN0aW9uO1xuXG4gICAgcXVlcnlCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBxdWVyeSk7XG4gICAgc2VhcmNoQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgc2VhcmNoKTtcblxuICAgIGNvbnN0IHJhZGlvVG9GdW5jdGlvbjogeyBbaWQ6IHN0cmluZ106IFNlYXJjaEZ1bmN0aW9uIH0gPSB7XG4gICAgICAgICd1bmlmb3JtLWNvc3QtcmFkaW8nOiB1bmlmb3JtQ29zdFNlYXJjaCxcbiAgICAgICAgJ2dyZWVkeS1yYWRpbyc6IGdyZWVkeVNlYXJjaCxcbiAgICAgICAgJ2Etc3Rhci1yYWRpbyc6IGFTdGFyU2VhcmNoXG4gICAgfTtcbiAgICBmb3IgKGNvbnN0IGlkIGluIHJhZGlvVG9GdW5jdGlvbikge1xuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjJyArIGlkKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgICAgICAgIHNlYXJjaEZ1bmN0aW9uID0gcmFkaW9Ub0Z1bmN0aW9uW2lkXTtcbiAgICAgICAgICAgIGNoZWNrU2VhcmNoQnV0dG9uKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGJhY2tCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBjaG9vc2VBZ2Fpbik7XG5cbiAgICBjb25zdCBub2RlSWRUb0NpcmNsZSA9IG5ldyBNYXA8bnVtYmVyLCBMLkNpcmNsZT4oKTtcblxuICAgIGxldCBwYXRoTGluZTogTC5Qb2x5bGluZSB8IG51bGwgPSBudWxsO1xuXG4gICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihcbiAgICAgICAgcG9zID0+IGluaXQocG9zLmNvb3Jkcy5sYXRpdHVkZSwgcG9zLmNvb3Jkcy5sb25naXR1ZGUpLFxuICAgICAgICAoKSA9PiBpbml0KDI1LjExNjAzNSwgMTIxLjUyOTk0NikgLy8gZmFsbGJhY2sgdG8gVEFTXG4gICAgKTtcblxuICAgIGZ1bmN0aW9uIGluaXQobGF0OiBudW1iZXIsIGxuZzogbnVtYmVyKSB7XG5cbiAgICAgICAgbWFwID0gTC5tYXAoJ21hcCcsIHtcbiAgICAgICAgICAgIGNlbnRlcjogW2xhdCwgbG5nXSxcbiAgICAgICAgICAgIHpvb206IDE3LFxuICAgICAgICAgICAgd29ybGRDb3B5SnVtcDogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICBMLnRpbGVMYXllcignaHR0cDovL3tzfS50aWxlLm9zbS5vcmcve3p9L3t4fS97eX0ucG5nJywge1xuICAgICAgICAgICAgYXR0cmlidXRpb246ICcmY29weTsgPGEgaHJlZj1cImh0dHA6Ly9vc20ub3JnL2NvcHlyaWdodFwiPk9wZW5TdHJlZXRNYXA8L2E+IGNvbnRyaWJ1dG9ycycsXG4gICAgICAgICAgICBtYXhab29tOiAyMSxcbiAgICAgICAgICAgIG1heE5hdGl2ZVpvb206IDE5XG4gICAgICAgIH0pLmFkZFRvKG1hcCk7XG5cbiAgICAgICAgbWFwLm9uKCd6b29tJywgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKG1hcC5nZXRab29tKCkgPCAxMykge1xuICAgICAgICAgICAgICAgIHF1ZXJ5QnV0dG9uLmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBzaG93RWxlbShhcmVhVG9vQmlnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcXVlcnlCdXR0b24uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBoaWRlRWxlbShhcmVhVG9vQmlnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgc2hvd09ubHkoaW50cm9TY3JlZW4pO1xuXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcXVlcnkoKSB7XG5cbiAgICAgICAgc2hvd09ubHkocXVlcnlpbmdTY3JlZW4pO1xuXG4gICAgICAgIGNvbnN0IGJvdW5kcyA9IG1hcC5nZXRCb3VuZHMoKTtcbiAgICAgICAgY29uc3Qgb3ZlcnBhc3NRTCA9IGBbb3V0Ompzb25dO3dheVtoaWdod2F5XSgke2JvdW5kcy5nZXRTb3V0aCgpfSwke2JvdW5kcy5nZXRXZXN0KCl9LCR7Ym91bmRzLmdldE5vcnRoKCl9LCR7Ym91bmRzLmdldEVhc3QoKX0pO291dCBnZW9tO2A7XG5cbiAgICAgICAgZmV0Y2goJ2h0dHBzOi8vb3ZlcnBhc3MtYXBpLmRlL2FwaS9pbnRlcnByZXRlcj9kYXRhPScgKyBvdmVycGFzc1FMKVxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpXG4gICAgICAgICAgICAudGhlbihjcmVhdGVOb2Rlcyk7XG5cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBjcmVhdGVOb2RlcyhkYXRhOiBPdmVycGFzc0pTT04pIHtcblxuICAgICAgICBjb25zdCBub2RlcyA9IG92ZXJwYXNzVG9HcmFwaE5vZGVzKGRhdGEpO1xuXG4gICAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiBub2Rlcykge1xuXG4gICAgICAgICAgICBjb25zdCBjaXJjbGUgPSBMLmNpcmNsZShub2RlLCB7XG4gICAgICAgICAgICAgICAgcmFkaXVzOiA2LFxuICAgICAgICAgICAgICAgIHN0cm9rZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgZmlsbE9wYWNpdHk6IDAuNyxcbiAgICAgICAgICAgICAgICBjb2xvcjogY29sb3JzLmRlZmF1bHRcbiAgICAgICAgICAgIH0pLmJpbmRQb3B1cCgoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBlbGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBpZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgICAgIGlkLnRleHRDb250ZW50ID0gbm9kZS5pZC50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIGVsZW0uYXBwZW5kQ2hpbGQoaWQpO1xuXG4gICAgICAgICAgICAgICAgY29uc3Qgc3RhcnRMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xuICAgICAgICAgICAgICAgIHN0YXJ0TGluay5ocmVmID0gJyMnO1xuICAgICAgICAgICAgICAgIHN0YXJ0TGluay50ZXh0Q29udGVudCA9ICdTZXQgYXMgc3RhcnQnO1xuICAgICAgICAgICAgICAgIHN0YXJ0TGluay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGdvYWxOb2RlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBnb2FsTm9kZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICBnb2FsTm9kZUlkRWxlbS50ZXh0Q29udGVudCA9ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgKG5vZGVJZFRvQ2lyY2xlLmdldChub2RlLmlkKSBhcyBMLkNpcmNsZSkuc2V0U3R5bGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZGVmYXVsdFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0Tm9kZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgKG5vZGVJZFRvQ2lyY2xlLmdldChzdGFydE5vZGUuaWQpIGFzIEwuQ2lyY2xlKS5zZXRTdHlsZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IGNvbG9ycy5kZWZhdWx0XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzdGFydE5vZGUgPSBub2RlO1xuICAgICAgICAgICAgICAgICAgICBzdGFydE5vZGVJZEVsZW0udGV4dENvbnRlbnQgPSBzdGFydE5vZGUuaWQudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tTZWFyY2hCdXR0b24oKTtcbiAgICAgICAgICAgICAgICAgICAgY2lyY2xlLmNsb3NlUG9wdXAoKTtcbiAgICAgICAgICAgICAgICAgICAgKGNpcmNsZSBhcyBMLkNpcmNsZSkuc2V0U3R5bGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IGNvbG9ycy5zdGFydFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBlbGVtLmFwcGVuZENoaWxkKHN0YXJ0TGluayk7XG5cbiAgICAgICAgICAgICAgICBlbGVtLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2JyJykpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgZ29hbExpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XG4gICAgICAgICAgICAgICAgZ29hbExpbmsuaHJlZiA9ICcjJztcbiAgICAgICAgICAgICAgICBnb2FsTGluay50ZXh0Q29udGVudCA9ICdTZXQgYXMgZ29hbCc7XG4gICAgICAgICAgICAgICAgZ29hbExpbmsuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBzdGFydE5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0Tm9kZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydE5vZGVJZEVsZW0udGV4dENvbnRlbnQgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIChub2RlSWRUb0NpcmNsZS5nZXQobm9kZS5pZCkgYXMgTC5DaXJjbGUpLnNldFN0eWxlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogY29sb3JzLmRlZmF1bHRcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChnb2FsTm9kZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgKG5vZGVJZFRvQ2lyY2xlLmdldChnb2FsTm9kZS5pZCkgYXMgTC5DaXJjbGUpLnNldFN0eWxlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogY29sb3JzLmRlZmF1bHRcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGdvYWxOb2RlID0gbm9kZTtcbiAgICAgICAgICAgICAgICAgICAgZ29hbE5vZGVJZEVsZW0udGV4dENvbnRlbnQgPSBnb2FsTm9kZS5pZC50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICBjaGVja1NlYXJjaEJ1dHRvbigpO1xuICAgICAgICAgICAgICAgICAgICBjaXJjbGUuY2xvc2VQb3B1cCgpO1xuICAgICAgICAgICAgICAgICAgICAoY2lyY2xlIGFzIEwuQ2lyY2xlKS5zZXRTdHlsZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogY29sb3JzLmdvYWxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgZWxlbS5hcHBlbmRDaGlsZChnb2FsTGluayk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbTtcblxuICAgICAgICAgICAgfSkuYWRkVG8obWFwKTtcblxuICAgICAgICAgICAgbm9kZUlkVG9DaXJjbGUuc2V0KG5vZGUuaWQsIGNpcmNsZSk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIG5vZGVzQ3JlYXRlZEVsZW0udGV4dENvbnRlbnQgPSBub2Rlcy5sZW5ndGgudG9TdHJpbmcoKTtcblxuICAgICAgICBzaG93T25seShjaG9vc2VTY3JlZW4pO1xuXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gc2VhcmNoKCkge1xuXG4gICAgICAgIGNvbnN0IHsgZXhwYW5kZWQsIHBhdGgsIGZyaW5nZSB9ID1cbiAgICAgICAgICAgIHNlYXJjaEZ1bmN0aW9uKHN0YXJ0Tm9kZSBhcyBHcmFwaE5vZGUsIGdvYWxOb2RlIGFzIEdyYXBoTm9kZSk7XG5cbiAgICAgICAgZXhwYW5kZWRSZXN1bHQudGV4dENvbnRlbnQgPSBleHBhbmRlZC5sZW5ndGgudG9TdHJpbmcoKTtcbiAgICAgICAgZm9yIChjb25zdCBleHAgb2YgZXhwYW5kZWQpIHtcbiAgICAgICAgICAgIGlmIChleHAgIT09IHN0YXJ0Tm9kZSAmJiBleHAgIT09IGdvYWxOb2RlKSB7XG4gICAgICAgICAgICAgICAgKG5vZGVJZFRvQ2lyY2xlLmdldChleHAuaWQpIGFzIEwuQ2lyY2xlKS5zZXRTdHlsZSh7XG4gICAgICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZXhwYW5kZWRcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYXRoID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHBhdGhSZXN1bHQudGV4dENvbnRlbnQgPSAnUGF0aCBub3QgZm91bmQuJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHBhdGhSZXN1bHQudGV4dENvbnRlbnQgPSBgUGF0aCBmb3VuZCB3aXRoICR7cGF0aC5sZW5ndGh9IG5vZGVzLmA7XG4gICAgICAgICAgICBwYXRoTGluZSA9IEwucG9seWxpbmUocGF0aCwge1xuICAgICAgICAgICAgICAgIHdlaWdodDogOCxcbiAgICAgICAgICAgICAgICBjb2xvcjogY29sb3JzLnBhdGhcbiAgICAgICAgICAgIH0pLmFkZFRvKG1hcCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZnJpbmdlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGZyaW5nZVJlc3VsdC50ZXh0Q29udGVudCA9ICdObyc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmcmluZ2VSZXN1bHQudGV4dENvbnRlbnQgPSBmcmluZ2UubGVuZ3RoLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICB3aGlsZSAoZnJpbmdlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAobm9kZUlkVG9DaXJjbGUuZ2V0KGZyaW5nZS5kZXF1ZXVlKCkuaWQpIGFzIEwuQ2lyY2xlKS5zZXRTdHlsZSh7XG4gICAgICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZnJpbmdlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBzaG93T25seShyZXN1bHRzU2NyZWVuKTtcblxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGNob29zZUFnYWluKCkge1xuXG4gICAgICAgIGZvciAoY29uc3QgW2lkLCBjaXJjbGVdIG9mIG5vZGVJZFRvQ2lyY2xlLmVudHJpZXMoKSkge1xuICAgICAgICAgICAgaWYgKGlkICE9PSAoc3RhcnROb2RlIGFzIEdyYXBoTm9kZSkuaWQgJiYgaWQgIT09IChnb2FsTm9kZSBhcyBHcmFwaE5vZGUpLmlkKSB7XG4gICAgICAgICAgICAgICAgY2lyY2xlLnNldFN0eWxlKHtcbiAgICAgICAgICAgICAgICAgICAgY29sb3I6IGNvbG9ycy5kZWZhdWx0XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGF0aExpbmUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHBhdGhMaW5lLnJlbW92ZSgpO1xuICAgICAgICAgICAgcGF0aExpbmUgPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgc2hvd09ubHkoY2hvb3NlU2NyZWVuKTtcblxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGNoZWNrU2VhcmNoQnV0dG9uKCkge1xuICAgICAgICBzZWFyY2hCdXR0b24uZGlzYWJsZWQgPSAhKHN0YXJ0Tm9kZSAmJiBnb2FsTm9kZSAmJiBzZWFyY2hGdW5jdGlvbik7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gc2hvd09ubHkoZWxlbTogSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHNpZGViYXJJdGVtcykge1xuICAgICAgICAgICAgaGlkZUVsZW0oaXRlbSk7XG4gICAgICAgIH1cbiAgICAgICAgc2hvd0VsZW0oZWxlbSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gc2hvd0VsZW0oZWxlbTogSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgZWxlbS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICB9XG4gICAgXG4gICAgZnVuY3Rpb24gaGlkZUVsZW0oZWxlbTogSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgZWxlbS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgIH1cblxufSkoKTtcbiJdfQ==