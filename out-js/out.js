'use strict';
const uniformCostSearch = (start, goal) => bestFirstSearch(start, goal, ({ parentScore, distance }) => parentScore + distance);
const greedySearch = (start, goal) => bestFirstSearch(start, goal, ({ node }) => distanceBetween(node, goal));
const aStarSearch = (start, goal) => bestFirstSearch(start, goal, ({ node, parentScore, distance }) => parentScore + distance + distanceBetween(node, goal));
function bestFirstSearch(start, goal, scoreFunc) {
    const expanded = [];
    const scores = new Map([[start.id, scoreFunc({
                node: start,
                parentScore: 0,
                distance: 0
            })]]);
    const parents = new Map();
    const fringe = new PriorityQueue({
        comparator: (a, b) => scores.get(a.id) - scores.get(b.id),
        initialValues: [start]
    });
    while (fringe.length > 0) {
        const current = fringe.dequeue();
        if (expanded.includes(current)) {
            continue;
        }
        expanded.push(current);
        const currentScore = scores.get(current.id);
        if (current === goal) {
            const path = [goal];
            let parent = goal;
            while (parent !== start) {
                parent = parents.get(parent.id);
                path.unshift(parent);
            }
            return { expanded, path, fringe };
        }
        for (const { distance, child } of current.connections) {
            if (expanded.includes(child)) {
                continue;
            }
            const oldChildScore = scores.get(child.id);
            const newChildScore = scoreFunc({
                node: child,
                parentScore: currentScore,
                distance
            });
            if (oldChildScore === undefined || newChildScore < oldChildScore) {
                scores.set(child.id, newChildScore);
                parents.set(child.id, current);
                fringe.queue(child);
            }
        }
    }
    return { expanded };
}
function distanceBetween(a, b) {
    return Math.sqrt(Math.pow(a.lat - b.lat, 2) + Math.pow(a.lng - b.lng, 2));
}
function overpassToGraphNodes({ elements }) {
    const graphNodes = [];
    for (const { nodes, geometry, tags: { junction } } of elements) {
        let prevGraphNode;
        let firstGraphNode;
        nodes.forEach((nodeId, i) => {
            let graphNode = graphNodes.find(graphNode => graphNode.id === nodeId);
            if (graphNode === undefined) {
                graphNode = {
                    id: nodeId,
                    lat: geometry[i].lat,
                    lng: geometry[i].lon,
                    connections: []
                };
                graphNodes.push(graphNode);
            }
            if (i === 0) {
                firstGraphNode = graphNode;
            }
            else {
                connect(graphNode, prevGraphNode);
            }
            if (i === nodes.length - 1 && junction === 'roundabout') {
                connect(graphNode, firstGraphNode);
            }
            prevGraphNode = graphNode;
        });
    }
    return graphNodes;
    function connect(a, b) {
        const distance = distanceBetween(a, b);
        a.connections.push({ distance, child: b });
        b.connections.push({ distance, child: a });
    }
}
'use strict';
onerror = alert;
(() => {
    const qs = document.querySelector.bind(document);
    const qsa = document.querySelectorAll.bind(document);
    const introScreen = qs('#intro-screen');
    const queryButton = qs('#query-button');
    const areaTooBig = qs('#area-too-big-warning');
    const queryingScreen = qs('#querying-screen');
    const chooseScreen = qs('#choose-screen');
    const nodesCreatedElem = qs('#nodes-created');
    const startNodeIdElem = qs('#start-node-id');
    const goalNodeIdElem = qs('#goal-node-id');
    const searchButton = qs('#search-button');
    const resultsScreen = qs('#results-screen');
    const pathResult = qs('#path-result');
    const expandedResult = qs('#expanded-result');
    const fringeResult = qs('#fringe-result');
    const backButton = qs('#back-button');
    const sidebarItems = Array.prototype.slice.call(qsa('#sidebar > *'));
    const colors = {
        default: '#3388ff',
        start: 'red',
        goal: 'green',
        expanded: 'darkblue',
        path: '#009688',
        fringe: 'orange'
    };
    let map;
    let startNode = null;
    let goalNode = null;
    let searchFunction;
    queryButton.addEventListener('click', query);
    searchButton.addEventListener('click', search);
    const radioToFunction = {
        'uniform-cost-radio': uniformCostSearch,
        'greedy-radio': greedySearch,
        'a-star-radio': aStarSearch
    };
    for (const id in radioToFunction) {
        document.querySelector('#' + id).addEventListener('click', () => {
            searchFunction = radioToFunction[id];
            checkSearchButton();
        });
    }
    backButton.addEventListener('click', chooseAgain);
    const nodeIdToCircle = new Map();
    let pathLine = null;
    navigator.geolocation.getCurrentPosition(pos => init(pos.coords.latitude, pos.coords.longitude), () => init(25.116035, 121.529946) // fallback to TAS
    );
    function init(lat, lng) {
        map = L.map('map', {
            center: [lat, lng],
            zoom: 17,
            worldCopyJump: true
        });
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 21,
            maxNativeZoom: 19
        }).addTo(map);
        map.on('zoom', () => {
            if (map.getZoom() < 13) {
                queryButton.disabled = true;
                showElem(areaTooBig);
            }
            else {
                queryButton.disabled = false;
                hideElem(areaTooBig);
            }
        });
        showOnly(introScreen);
    }
    function query() {
        showOnly(queryingScreen);
        const bounds = map.getBounds();
        const overpassQL = `[out:json];way[highway](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});out geom;`;
        fetch('https://overpass-api.de/api/interpreter?data=' + overpassQL)
            .then(res => res.json())
            .then(createNodes);
    }
    function createNodes(data) {
        const nodes = overpassToGraphNodes(data);
        for (const node of nodes) {
            const circle = L.circle(node, {
                radius: 6,
                stroke: false,
                fillOpacity: 0.7,
                color: colors.default
            }).bindPopup(() => {
                const elem = document.createElement('div');
                const id = document.createElement('div');
                id.textContent = node.id.toString();
                elem.appendChild(id);
                const startLink = document.createElement('a');
                startLink.href = '#';
                startLink.textContent = 'Set as start';
                startLink.addEventListener('click', () => {
                    if (node === goalNode) {
                        goalNode = null;
                        goalNodeIdElem.textContent = '';
                        nodeIdToCircle.get(node.id).setStyle({
                            color: colors.default
                        });
                    }
                    if (startNode !== null) {
                        nodeIdToCircle.get(startNode.id).setStyle({
                            color: colors.default
                        });
                    }
                    startNode = node;
                    startNodeIdElem.textContent = startNode.id.toString();
                    checkSearchButton();
                    circle.closePopup();
                    circle.setStyle({
                        color: colors.start
                    });
                });
                elem.appendChild(startLink);
                elem.appendChild(document.createElement('br'));
                const goalLink = document.createElement('a');
                goalLink.href = '#';
                goalLink.textContent = 'Set as goal';
                goalLink.addEventListener('click', () => {
                    if (node === startNode) {
                        startNode = null;
                        startNodeIdElem.textContent = '';
                        nodeIdToCircle.get(node.id).setStyle({
                            color: colors.default
                        });
                    }
                    if (goalNode !== null) {
                        nodeIdToCircle.get(goalNode.id).setStyle({
                            color: colors.default
                        });
                    }
                    goalNode = node;
                    goalNodeIdElem.textContent = goalNode.id.toString();
                    checkSearchButton();
                    circle.closePopup();
                    circle.setStyle({
                        color: colors.goal
                    });
                });
                elem.appendChild(goalLink);
                return elem;
            }).addTo(map);
            nodeIdToCircle.set(node.id, circle);
        }
        nodesCreatedElem.textContent = nodes.length.toString();
        showOnly(chooseScreen);
    }
    function search() {
        const { expanded, path, fringe } = searchFunction(startNode, goalNode);
        expandedResult.textContent = expanded.length.toString();
        for (const exp of expanded) {
            if (exp !== startNode && exp !== goalNode) {
                nodeIdToCircle.get(exp.id).setStyle({
                    color: colors.expanded
                });
            }
        }
        if (path === undefined) {
            pathResult.textContent = 'Path not found.';
        }
        else {
            pathResult.textContent = `Path found with ${path.length} nodes.`;
            pathLine = L.polyline(path, {
                weight: 8,
                color: colors.path
            }).addTo(map);
        }
        if (fringe === undefined) {
            fringeResult.textContent = 'No';
        }
        else {
            fringeResult.textContent = fringe.length.toString();
            while (fringe.length > 0) {
                nodeIdToCircle.get(fringe.dequeue().id).setStyle({
                    color: colors.fringe
                });
            }
        }
        showOnly(resultsScreen);
    }
    function chooseAgain() {
        for (const [id, circle] of nodeIdToCircle.entries()) {
            if (id !== startNode.id && id !== goalNode.id) {
                circle.setStyle({
                    color: colors.default
                });
            }
        }
        if (pathLine !== null) {
            pathLine.remove();
            pathLine = null;
        }
        showOnly(chooseScreen);
    }
    function checkSearchButton() {
        searchButton.disabled = !(startNode && goalNode && searchFunction);
    }
    function showOnly(elem) {
        for (const item of sidebarItems) {
            hideElem(item);
        }
        showElem(elem);
    }
    function showElem(elem) {
        elem.style.display = 'block';
    }
    function hideElem(elem) {
        elem.style.display = 'none';
    }
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjLXRzL3NlYXJjaC50cyIsIi4uL3NyYy10cy91aS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUE2Q2IsTUFBTSxpQkFBaUIsR0FBbUIsQ0FBQyxLQUFLLEVBQUUsSUFBSSxLQUNsRCxlQUFlLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxLQUFLLFdBQVcsR0FBRyxRQUFRLENBQUMsQ0FBQztBQUV4RixNQUFNLFlBQVksR0FBbUIsQ0FBQyxLQUFLLEVBQUUsSUFBSSxLQUM3QyxlQUFlLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssZUFBZSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBRTVFLE1BQU0sV0FBVyxHQUFtQixDQUFDLEtBQUssRUFBRSxJQUFJLEtBQzVDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxLQUN6RCxXQUFXLEdBQUcsUUFBUSxHQUFHLGVBQWUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUU5RCx5QkFBeUIsS0FBZ0IsRUFBRSxJQUFlLEVBQzFELFNBQTBCO0lBQ3RCLE1BQU0sUUFBUSxHQUFnQixFQUFFLENBQUM7SUFDakMsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQVksQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsU0FBUyxDQUFDO2dCQUNwRCxJQUFJLEVBQUUsS0FBSztnQkFDWCxXQUFXLEVBQUUsQ0FBQztnQkFDZCxRQUFRLEVBQUUsQ0FBQzthQUNkLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNOLE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxFQUFpQixDQUFDO0lBQ3pDLE1BQU0sTUFB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O1FBRUQsRUFBRSxDQUFDLENBQUMsUUFBUSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDcEIsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ2xCLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDcEIsQ0FBQztRQUVELFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUUzQixDQUFDO0lBRUQ7UUFDSSxZQUFZLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxTQUFTLElBQUksUUFBUSxJQUFJLGNBQWMsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7SUFFRCxrQkFBa0IsSUFBaUI7UUFDL0IsR0FBRyxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQztZQUM5QixRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkIsQ0FBQztRQUNELFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBRUQsa0JBQWtCLElBQWlCO1FBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUNqQyxDQUFDO0lBRUQsa0JBQWtCLElBQWlCO1FBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUNoQyxDQUFDO0FBRUwsQ0FBQyxDQUFDLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbnR5cGUgSWQgPSBudW1iZXI7XHJcbnR5cGUgU2NvcmUgPSBudW1iZXI7XHJcbnR5cGUgRGlzdGFuY2UgPSBudW1iZXI7XHJcblxyXG5pbnRlcmZhY2UgR3JhcGhOb2RlIHtcclxuICAgIHJlYWRvbmx5IGxhdDogbnVtYmVyO1xyXG4gICAgcmVhZG9ubHkgbG5nOiBudW1iZXI7XHJcbiAgICByZWFkb25seSBpZDogSWQ7XHJcbiAgICByZWFkb25seSBjb25uZWN0aW9uczogQ29ubmVjdGlvbltdO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgQ29ubmVjdGlvbiB7IC8vIFwiQWRqYWNlbmN5XCIgaXMgdG9vIGhhcmQgdG8gc3BlbGxcclxuICAgIHJlYWRvbmx5IGRpc3RhbmNlOiBEaXN0YW5jZTtcclxuICAgIHJlYWRvbmx5IGNoaWxkOiBHcmFwaE5vZGU7XHJcbn1cclxuXHJcbnR5cGUgU2NvcmluZ0Z1bmN0aW9uID0gKGluZm86IHtcclxuICAgIG5vZGU6IEdyYXBoTm9kZTtcclxuICAgIHBhcmVudFNjb3JlOiBTY29yZTtcclxuICAgIGRpc3RhbmNlOiBEaXN0YW5jZTtcclxufSkgPT4gU2NvcmU7XHJcblxyXG5pbnRlcmZhY2UgT3ZlcnBhc3NKU09OIHtcclxuICAgIGVsZW1lbnRzOiB7XHJcbiAgICAgICAgbm9kZXM6IG51bWJlcltdO1xyXG4gICAgICAgIGdlb21ldHJ5OiB7XHJcbiAgICAgICAgICAgIGxhdDogbnVtYmVyO1xyXG4gICAgICAgICAgICBsb246IG51bWJlcjtcclxuICAgICAgICB9W107XHJcbiAgICAgICAgdGFnczoge1xyXG4gICAgICAgICAgICBqdW5jdGlvbjogc3RyaW5nXHJcbiAgICAgICAgfTtcclxuICAgIH1bXTtcclxufVxyXG5cclxudHlwZSBTZWFyY2hGdW5jdGlvbiA9IChzdGFydDogR3JhcGhOb2RlLCBnb2FsOiBHcmFwaE5vZGUpID0+IFNlYXJjaFJlc3VsdDtcclxuXHJcbnR5cGUgU2VhcmNoUmVzdWx0ID0ge1xyXG4gICAgZXhwYW5kZWQ6IEdyYXBoTm9kZVtdLFxyXG4gICAgcGF0aD86IEdyYXBoTm9kZVtdLFxyXG4gICAgZnJpbmdlPzogUHJpb3JpdHlRdWV1ZTxHcmFwaE5vZGU+XHJcbn07XHJcblxyXG5jb25zdCB1bmlmb3JtQ29zdFNlYXJjaDogU2VhcmNoRnVuY3Rpb24gPSAoc3RhcnQsIGdvYWwpID0+XHJcbiAgICBiZXN0Rmlyc3RTZWFyY2goc3RhcnQsIGdvYWwsICh7IHBhcmVudFNjb3JlLCBkaXN0YW5jZSB9KSA9PiBwYXJlbnRTY29yZSArIGRpc3RhbmNlKTtcclxuXHJcbmNvbnN0IGdyZWVkeVNlYXJjaDogU2VhcmNoRnVuY3Rpb24gPSAoc3RhcnQsIGdvYWwpID0+XHJcbiAgICBiZXN0Rmlyc3RTZWFyY2goc3RhcnQsIGdvYWwsICh7IG5vZGUgfSkgPT4gZGlzdGFuY2VCZXR3ZWVuKG5vZGUsIGdvYWwpKTtcclxuXHJcbmNvbnN0IGFTdGFyU2VhcmNoOiBTZWFyY2hGdW5jdGlvbiA9IChzdGFydCwgZ29hbCkgPT5cclxuICAgIGJlc3RGaXJzdFNlYXJjaChzdGFydCwgZ29hbCwgKHsgbm9kZSwgcGFyZW50U2NvcmUsIGRpc3RhbmNlIH0pID0+XHJcbiAgICAgICAgcGFyZW50U2NvcmUgKyBkaXN0YW5jZSArIGRpc3RhbmNlQmV0d2Vlbihub2RlLCBnb2FsKSk7XHJcblxyXG5mdW5jdGlvbiBiZXN0Rmlyc3RTZWFyY2goc3RhcnQ6IEdyYXBoTm9kZSwgZ29hbDogR3JhcGhOb2RlLFxyXG5zY29yZUZ1bmM6IFNjb3JpbmdGdW5jdGlvbik6IFNlYXJjaFJlc3VsdCB7XHJcbiAgICBjb25zdCBleHBhbmRlZDogR3JhcGhOb2RlW10gPSBbXTtcclxuICAgIGNvbnN0IHNjb3JlcyA9IG5ldyBNYXA8SWQsIFNjb3JlPihbW3N0YXJ0LmlkLCBzY29yZUZ1bmMoe1xyXG4gICAgICAgIG5vZGU6IHN0YXJ0LFxyXG4gICAgICAgIHBhcmVudFNjb3JlOiAwLFxyXG4gICAgICAgIGRpc3RhbmNlOiAwXHJcbiAgICB9KV1dKTtcclxuICAgIGNvbnN0IHBhcmVudHMgPSBuZXcgTWFwPElkLCBHcmFwaE5vZGU+KCk7XHJcbiAgICBjb25zdCBmcmluZ2UgPSBuZXcgUHJpb3JpdHlRdWV1ZTxHcmFwaE5vZGU+KHtcclxuICAgICAgICBjb21wYXJhdG9yOiAoYTogR3JhcGhOb2RlLCBiOiBHcmFwaE5vZGUpID0+IHNjb3Jlcy5nZXQoYS5pZCkgLSBzY29yZXMuZ2V0KGIuaWQpLFxyXG4gICAgICAgIGluaXRpYWxWYWx1ZXM6IFtzdGFydF1cclxuICAgIH0pO1xyXG4gICAgd2hpbGUgKGZyaW5nZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgY3VycmVudCA9IGZyaW5nZS5kZXF1ZXVlKCk7XHJcbiAgICAgICAgaWYgKGV4cGFuZGVkLmluY2x1ZGVzKGN1cnJlbnQpKSB7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBleHBhbmRlZC5wdXNoKGN1cnJlbnQpO1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRTY29yZSA9IHNjb3Jlcy5nZXQoY3VycmVudC5pZCkgYXMgU2NvcmU7XHJcbiAgICAgICAgaWYgKGN1cnJlbnQgPT09IGdvYWwpIHtcclxuICAgICAgICAgICAgY29uc3QgcGF0aCA9IFtnb2FsXTtcclxuICAgICAgICAgICAgbGV0IHBhcmVudCA9IGdvYWw7XHJcbiAgICAgICAgICAgIHdoaWxlIChwYXJlbnQgIT09IHN0YXJ0KSB7XHJcbiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnRzLmdldChwYXJlbnQuaWQpIGFzIEdyYXBoTm9kZTtcclxuICAgICAgICAgICAgICAgIHBhdGgudW5zaGlmdChwYXJlbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB7IGV4cGFuZGVkLCBwYXRoLCBmcmluZ2UgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yIChjb25zdCB7IGRpc3RhbmNlLCBjaGlsZCB9IG9mIGN1cnJlbnQuY29ubmVjdGlvbnMpIHtcclxuICAgICAgICAgICAgaWYgKGV4cGFuZGVkLmluY2x1ZGVzKGNoaWxkKSkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3Qgb2xkQ2hpbGRTY29yZSA9IHNjb3Jlcy5nZXQoY2hpbGQuaWQpO1xyXG4gICAgICAgICAgICBjb25zdCBuZXdDaGlsZFNjb3JlID0gc2NvcmVGdW5jKHtcclxuICAgICAgICAgICAgICAgIG5vZGU6IGNoaWxkLFxyXG4gICAgICAgICAgICAgICAgcGFyZW50U2NvcmU6IGN1cnJlbnRTY29yZSxcclxuICAgICAgICAgICAgICAgIGRpc3RhbmNlXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZiAob2xkQ2hpbGRTY29yZSA9PT0gdW5kZWZpbmVkIHx8IG5ld0NoaWxkU2NvcmUgPCBvbGRDaGlsZFNjb3JlKSB7XHJcbiAgICAgICAgICAgICAgICBzY29yZXMuc2V0KGNoaWxkLmlkLCBuZXdDaGlsZFNjb3JlKTtcclxuICAgICAgICAgICAgICAgIHBhcmVudHMuc2V0KGNoaWxkLmlkLCBjdXJyZW50KTtcclxuICAgICAgICAgICAgICAgIGZyaW5nZS5xdWV1ZShjaGlsZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4geyBleHBhbmRlZCB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBkaXN0YW5jZUJldHdlZW4oYTogR3JhcGhOb2RlLCBiOiBHcmFwaE5vZGUpIHtcclxuICAgIHJldHVybiBNYXRoLnNxcnQoTWF0aC5wb3coYS5sYXQgLSBiLmxhdCwgMikgKyBNYXRoLnBvdyhhLmxuZyAtIGIubG5nLCAyKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG92ZXJwYXNzVG9HcmFwaE5vZGVzKHsgZWxlbWVudHMgfTogT3ZlcnBhc3NKU09OKSB7XHJcbiAgICBjb25zdCBncmFwaE5vZGVzOiBHcmFwaE5vZGVbXSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCB7IG5vZGVzLCBnZW9tZXRyeSwgdGFnczogeyBqdW5jdGlvbiB9IH0gb2YgZWxlbWVudHMpIHtcclxuICAgICAgICBsZXQgcHJldkdyYXBoTm9kZTogR3JhcGhOb2RlO1xyXG4gICAgICAgIGxldCBmaXJzdEdyYXBoTm9kZTogR3JhcGhOb2RlO1xyXG4gICAgICAgIG5vZGVzLmZvckVhY2goKG5vZGVJZCwgaSkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgZ3JhcGhOb2RlID0gZ3JhcGhOb2Rlcy5maW5kKGdyYXBoTm9kZSA9PiBncmFwaE5vZGUuaWQgPT09IG5vZGVJZCk7XHJcbiAgICAgICAgICAgIGlmIChncmFwaE5vZGUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgZ3JhcGhOb2RlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlkOiBub2RlSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgbGF0OiBnZW9tZXRyeVtpXS5sYXQsXHJcbiAgICAgICAgICAgICAgICAgICAgbG5nOiBnZW9tZXRyeVtpXS5sb24sXHJcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbnM6IFtdIGFzIENvbm5lY3Rpb25bXVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGdyYXBoTm9kZXMucHVzaChncmFwaE5vZGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBmaXJzdEdyYXBoTm9kZSA9IGdyYXBoTm9kZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbm5lY3QoZ3JhcGhOb2RlLCBwcmV2R3JhcGhOb2RlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaSA9PT0gbm9kZXMubGVuZ3RoIC0gMSAmJiBqdW5jdGlvbiA9PT0gJ3JvdW5kYWJvdXQnKSB7XHJcbiAgICAgICAgICAgICAgICBjb25uZWN0KGdyYXBoTm9kZSwgZmlyc3RHcmFwaE5vZGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHByZXZHcmFwaE5vZGUgPSBncmFwaE5vZGU7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZ3JhcGhOb2RlcztcclxuICAgIGZ1bmN0aW9uIGNvbm5lY3QoYTogR3JhcGhOb2RlLCBiOiBHcmFwaE5vZGUpIHtcclxuICAgICAgICBjb25zdCBkaXN0YW5jZSA9IGRpc3RhbmNlQmV0d2VlbihhLCBiKTtcclxuICAgICAgICBhLmNvbm5lY3Rpb25zLnB1c2goeyBkaXN0YW5jZSwgY2hpbGQ6IGIgfSk7XHJcbiAgICAgICAgYi5jb25uZWN0aW9ucy5wdXNoKHsgZGlzdGFuY2UsIGNoaWxkOiBhIH0pO1xyXG4gICAgfVxyXG59IiwiJ3VzZSBzdHJpY3QnO1xyXG5cclxub25lcnJvciA9IGFsZXJ0O1xyXG5cclxuKCgpID0+IHtcclxuXHJcbiAgICBjb25zdCBxczogdHlwZW9mIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yLmJpbmQoZG9jdW1lbnQpO1xyXG4gICAgY29uc3QgcXNhOiB0eXBlb2YgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwuYmluZChkb2N1bWVudCk7XHJcblxyXG4gICAgY29uc3QgaW50cm9TY3JlZW4gPSBxcygnI2ludHJvLXNjcmVlbicpIGFzIEhUTUxFbGVtZW50O1xyXG4gICAgY29uc3QgcXVlcnlCdXR0b24gPSBxcygnI3F1ZXJ5LWJ1dHRvbicpIGFzIEhUTUxCdXR0b25FbGVtZW50O1xyXG4gICAgY29uc3QgYXJlYVRvb0JpZyA9IHFzKCcjYXJlYS10b28tYmlnLXdhcm5pbmcnKSBhcyBIVE1MRWxlbWVudDtcclxuICAgIGNvbnN0IHF1ZXJ5aW5nU2NyZWVuID0gcXMoJyNxdWVyeWluZy1zY3JlZW4nKSBhcyBIVE1MRWxlbWVudDtcclxuICAgIGNvbnN0IGNob29zZVNjcmVlbiA9IHFzKCcjY2hvb3NlLXNjcmVlbicpIGFzIEhUTUxFbGVtZW50O1xyXG4gICAgY29uc3Qgbm9kZXNDcmVhdGVkRWxlbSA9IHFzKCcjbm9kZXMtY3JlYXRlZCcpO1xyXG4gICAgY29uc3Qgc3RhcnROb2RlSWRFbGVtID0gcXMoJyNzdGFydC1ub2RlLWlkJyk7XHJcbiAgICBjb25zdCBnb2FsTm9kZUlkRWxlbSA9IHFzKCcjZ29hbC1ub2RlLWlkJyk7XHJcbiAgICBjb25zdCBzZWFyY2hCdXR0b24gPSBxcygnI3NlYXJjaC1idXR0b24nKSBhcyBIVE1MQnV0dG9uRWxlbWVudDtcclxuICAgIGNvbnN0IHJlc3VsdHNTY3JlZW4gPSBxcygnI3Jlc3VsdHMtc2NyZWVuJykgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICBjb25zdCBwYXRoUmVzdWx0ID0gcXMoJyNwYXRoLXJlc3VsdCcpO1xyXG4gICAgY29uc3QgZXhwYW5kZWRSZXN1bHQgPSBxcygnI2V4cGFuZGVkLXJlc3VsdCcpO1xyXG4gICAgY29uc3QgZnJpbmdlUmVzdWx0ID0gcXMoJyNmcmluZ2UtcmVzdWx0Jyk7XHJcbiAgICBjb25zdCBiYWNrQnV0dG9uID0gcXMoJyNiYWNrLWJ1dHRvbicpIGFzIEhUTUxCdXR0b25FbGVtZW50O1xyXG5cclxuICAgIGNvbnN0IHNpZGViYXJJdGVtcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHFzYSgnI3NpZGViYXIgPiAqJykpIGFzIEhUTUxFbGVtZW50W107XHJcblxyXG4gICAgY29uc3QgY29sb3JzID0ge1xyXG4gICAgICAgIGRlZmF1bHQ6ICcjMzM4OGZmJyxcclxuICAgICAgICBzdGFydDogJ3JlZCcsXHJcbiAgICAgICAgZ29hbDogJ2dyZWVuJyxcclxuICAgICAgICBleHBhbmRlZDogJ2RhcmtibHVlJyxcclxuICAgICAgICBwYXRoOiAnIzAwOTY4OCcsXHJcbiAgICAgICAgZnJpbmdlOiAnb3JhbmdlJ1xyXG4gICAgfTtcclxuXHJcbiAgICBsZXQgbWFwOiBMLk1hcDtcclxuXHJcbiAgICBsZXQgc3RhcnROb2RlOiBHcmFwaE5vZGUgfCBudWxsID0gbnVsbDtcclxuICAgIGxldCBnb2FsTm9kZTogR3JhcGhOb2RlIHwgbnVsbCA9IG51bGw7XHJcbiAgICBsZXQgc2VhcmNoRnVuY3Rpb246IFNlYXJjaEZ1bmN0aW9uO1xyXG5cclxuICAgIHF1ZXJ5QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgcXVlcnkpO1xyXG4gICAgc2VhcmNoQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgc2VhcmNoKTtcclxuXHJcbiAgICBjb25zdCByYWRpb1RvRnVuY3Rpb246IHsgW2lkOiBzdHJpbmddOiBTZWFyY2hGdW5jdGlvbiB9ID0ge1xyXG4gICAgICAgICd1bmlmb3JtLWNvc3QtcmFkaW8nOiB1bmlmb3JtQ29zdFNlYXJjaCxcclxuICAgICAgICAnZ3JlZWR5LXJhZGlvJzogZ3JlZWR5U2VhcmNoLFxyXG4gICAgICAgICdhLXN0YXItcmFkaW8nOiBhU3RhclNlYXJjaFxyXG4gICAgfTtcclxuICAgIGZvciAoY29uc3QgaWQgaW4gcmFkaW9Ub0Z1bmN0aW9uKSB7XHJcbiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignIycgKyBpZCkuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHNlYXJjaEZ1bmN0aW9uID0gcmFkaW9Ub0Z1bmN0aW9uW2lkXTtcclxuICAgICAgICAgICAgY2hlY2tTZWFyY2hCdXR0b24oKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBiYWNrQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2hvb3NlQWdhaW4pO1xyXG5cclxuICAgIGNvbnN0IG5vZGVJZFRvQ2lyY2xlID0gbmV3IE1hcDxudW1iZXIsIEwuQ2lyY2xlPigpO1xyXG5cclxuICAgIGxldCBwYXRoTGluZTogTC5Qb2x5bGluZSB8IG51bGwgPSBudWxsO1xyXG5cclxuICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oXHJcbiAgICAgICAgcG9zID0+IGluaXQocG9zLmNvb3Jkcy5sYXRpdHVkZSwgcG9zLmNvb3Jkcy5sb25naXR1ZGUpLFxyXG4gICAgICAgICgpID0+IGluaXQoMjUuMTE2MDM1LCAxMjEuNTI5OTQ2KSAvLyBmYWxsYmFjayB0byBUQVNcclxuICAgICk7XHJcblxyXG4gICAgZnVuY3Rpb24gaW5pdChsYXQ6IG51bWJlciwgbG5nOiBudW1iZXIpIHtcclxuXHJcbiAgICAgICAgbWFwID0gTC5tYXAoJ21hcCcsIHtcclxuICAgICAgICAgICAgY2VudGVyOiBbbGF0LCBsbmddLFxyXG4gICAgICAgICAgICB6b29tOiAxNyxcclxuICAgICAgICAgICAgd29ybGRDb3B5SnVtcDogdHJ1ZVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBMLnRpbGVMYXllcignaHR0cDovL3tzfS50aWxlLm9zbS5vcmcve3p9L3t4fS97eX0ucG5nJywge1xyXG4gICAgICAgICAgICBhdHRyaWJ1dGlvbjogJyZjb3B5OyA8YSBocmVmPVwiaHR0cDovL29zbS5vcmcvY29weXJpZ2h0XCI+T3BlblN0cmVldE1hcDwvYT4gY29udHJpYnV0b3JzJyxcclxuICAgICAgICAgICAgbWF4Wm9vbTogMjEsXHJcbiAgICAgICAgICAgIG1heE5hdGl2ZVpvb206IDE5XHJcbiAgICAgICAgfSkuYWRkVG8obWFwKTtcclxuXHJcbiAgICAgICAgbWFwLm9uKCd6b29tJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAobWFwLmdldFpvb20oKSA8IDEzKSB7XHJcbiAgICAgICAgICAgICAgICBxdWVyeUJ1dHRvbi5kaXNhYmxlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBzaG93RWxlbShhcmVhVG9vQmlnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHF1ZXJ5QnV0dG9uLmRpc2FibGVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBoaWRlRWxlbShhcmVhVG9vQmlnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBzaG93T25seShpbnRyb1NjcmVlbik7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHF1ZXJ5KCkge1xyXG5cclxuICAgICAgICBzaG93T25seShxdWVyeWluZ1NjcmVlbik7XHJcblxyXG4gICAgICAgIGNvbnN0IGJvdW5kcyA9IG1hcC5nZXRCb3VuZHMoKTtcclxuICAgICAgICBjb25zdCBvdmVycGFzc1FMID0gYFtvdXQ6anNvbl07d2F5W2hpZ2h3YXldKCR7Ym91bmRzLmdldFNvdXRoKCl9LCR7Ym91bmRzLmdldFdlc3QoKX0sJHtib3VuZHMuZ2V0Tm9ydGgoKX0sJHtib3VuZHMuZ2V0RWFzdCgpfSk7b3V0IGdlb207YDtcclxuXHJcbiAgICAgICAgZmV0Y2goJ2h0dHBzOi8vb3ZlcnBhc3MtYXBpLmRlL2FwaS9pbnRlcnByZXRlcj9kYXRhPScgKyBvdmVycGFzc1FMKVxyXG4gICAgICAgICAgICAudGhlbihyZXMgPT4gcmVzLmpzb24oKSlcclxuICAgICAgICAgICAgLnRoZW4oY3JlYXRlTm9kZXMpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVOb2RlcyhkYXRhOiBPdmVycGFzc0pTT04pIHtcclxuXHJcbiAgICAgICAgY29uc3Qgbm9kZXMgPSBvdmVycGFzc1RvR3JhcGhOb2RlcyhkYXRhKTtcclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjaXJjbGUgPSBMLmNpcmNsZShub2RlLCB7XHJcbiAgICAgICAgICAgICAgICByYWRpdXM6IDYsXHJcbiAgICAgICAgICAgICAgICBzdHJva2U6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgZmlsbE9wYWNpdHk6IDAuNyxcclxuICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZGVmYXVsdFxyXG4gICAgICAgICAgICB9KS5iaW5kUG9wdXAoKCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgICAgICAgICAgaWQudGV4dENvbnRlbnQgPSBub2RlLmlkLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgICAgICBlbGVtLmFwcGVuZENoaWxkKGlkKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBzdGFydExpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XHJcbiAgICAgICAgICAgICAgICBzdGFydExpbmsuaHJlZiA9ICcjJztcclxuICAgICAgICAgICAgICAgIHN0YXJ0TGluay50ZXh0Q29udGVudCA9ICdTZXQgYXMgc3RhcnQnO1xyXG4gICAgICAgICAgICAgICAgc3RhcnRMaW5rLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBnb2FsTm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBnb2FsTm9kZSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGdvYWxOb2RlSWRFbGVtLnRleHRDb250ZW50ID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChub2RlSWRUb0NpcmNsZS5nZXQobm9kZS5pZCkgYXMgTC5DaXJjbGUpLnNldFN0eWxlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZGVmYXVsdFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0Tm9kZSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAobm9kZUlkVG9DaXJjbGUuZ2V0KHN0YXJ0Tm9kZS5pZCkgYXMgTC5DaXJjbGUpLnNldFN0eWxlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZGVmYXVsdFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnROb2RlID0gbm9kZTtcclxuICAgICAgICAgICAgICAgICAgICBzdGFydE5vZGVJZEVsZW0udGV4dENvbnRlbnQgPSBzdGFydE5vZGUuaWQudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgICAgICAgICBjaGVja1NlYXJjaEJ1dHRvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNpcmNsZS5jbG9zZVBvcHVwKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgKGNpcmNsZSBhcyBMLkNpcmNsZSkuc2V0U3R5bGUoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogY29sb3JzLnN0YXJ0XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGVsZW0uYXBwZW5kQ2hpbGQoc3RhcnRMaW5rKTtcclxuXHJcbiAgICAgICAgICAgICAgICBlbGVtLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2JyJykpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG4gICAgICAgICAgICAgICAgZ29hbExpbmsuaHJlZiA9ICcjJztcclxuICAgICAgICAgICAgICAgIGdvYWxMaW5rLnRleHRDb250ZW50ID0gJ1NldCBhcyBnb2FsJztcclxuICAgICAgICAgICAgICAgIGdvYWxMaW5rLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBzdGFydE5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnROb2RlID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnROb2RlSWRFbGVtLnRleHRDb250ZW50ID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChub2RlSWRUb0NpcmNsZS5nZXQobm9kZS5pZCkgYXMgTC5DaXJjbGUpLnNldFN0eWxlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZGVmYXVsdFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGdvYWxOb2RlICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChub2RlSWRUb0NpcmNsZS5nZXQoZ29hbE5vZGUuaWQpIGFzIEwuQ2lyY2xlKS5zZXRTdHlsZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogY29sb3JzLmRlZmF1bHRcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGdvYWxOb2RlID0gbm9kZTtcclxuICAgICAgICAgICAgICAgICAgICBnb2FsTm9kZUlkRWxlbS50ZXh0Q29udGVudCA9IGdvYWxOb2RlLmlkLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tTZWFyY2hCdXR0b24oKTtcclxuICAgICAgICAgICAgICAgICAgICBjaXJjbGUuY2xvc2VQb3B1cCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIChjaXJjbGUgYXMgTC5DaXJjbGUpLnNldFN0eWxlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IGNvbG9ycy5nb2FsXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGVsZW0uYXBwZW5kQ2hpbGQoZ29hbExpbmspO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBlbGVtO1xyXG5cclxuICAgICAgICAgICAgfSkuYWRkVG8obWFwKTtcclxuXHJcbiAgICAgICAgICAgIG5vZGVJZFRvQ2lyY2xlLnNldChub2RlLmlkLCBjaXJjbGUpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG5vZGVzQ3JlYXRlZEVsZW0udGV4dENvbnRlbnQgPSBub2Rlcy5sZW5ndGgudG9TdHJpbmcoKTtcclxuXHJcbiAgICAgICAgc2hvd09ubHkoY2hvb3NlU2NyZWVuKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2VhcmNoKCkge1xyXG5cclxuICAgICAgICBjb25zdCB7IGV4cGFuZGVkLCBwYXRoLCBmcmluZ2UgfSA9XHJcbiAgICAgICAgICAgIHNlYXJjaEZ1bmN0aW9uKHN0YXJ0Tm9kZSBhcyBHcmFwaE5vZGUsIGdvYWxOb2RlIGFzIEdyYXBoTm9kZSk7XHJcblxyXG4gICAgICAgIGV4cGFuZGVkUmVzdWx0LnRleHRDb250ZW50ID0gZXhwYW5kZWQubGVuZ3RoLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgZm9yIChjb25zdCBleHAgb2YgZXhwYW5kZWQpIHtcclxuICAgICAgICAgICAgaWYgKGV4cCAhPT0gc3RhcnROb2RlICYmIGV4cCAhPT0gZ29hbE5vZGUpIHtcclxuICAgICAgICAgICAgICAgIChub2RlSWRUb0NpcmNsZS5nZXQoZXhwLmlkKSBhcyBMLkNpcmNsZSkuc2V0U3R5bGUoe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZXhwYW5kZWRcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocGF0aCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHBhdGhSZXN1bHQudGV4dENvbnRlbnQgPSAnUGF0aCBub3QgZm91bmQuJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBwYXRoUmVzdWx0LnRleHRDb250ZW50ID0gYFBhdGggZm91bmQgd2l0aCAke3BhdGgubGVuZ3RofSBub2Rlcy5gO1xyXG4gICAgICAgICAgICBwYXRoTGluZSA9IEwucG9seWxpbmUocGF0aCwge1xyXG4gICAgICAgICAgICAgICAgd2VpZ2h0OiA4LFxyXG4gICAgICAgICAgICAgICAgY29sb3I6IGNvbG9ycy5wYXRoXHJcbiAgICAgICAgICAgIH0pLmFkZFRvKG1hcCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZnJpbmdlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgZnJpbmdlUmVzdWx0LnRleHRDb250ZW50ID0gJ05vJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBmcmluZ2VSZXN1bHQudGV4dENvbnRlbnQgPSBmcmluZ2UubGVuZ3RoLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgIHdoaWxlIChmcmluZ2UubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgKG5vZGVJZFRvQ2lyY2xlLmdldChmcmluZ2UuZGVxdWV1ZSgpLmlkKSBhcyBMLkNpcmNsZSkuc2V0U3R5bGUoe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZnJpbmdlXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgc2hvd09ubHkocmVzdWx0c1NjcmVlbik7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNob29zZUFnYWluKCkge1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IFtpZCwgY2lyY2xlXSBvZiBub2RlSWRUb0NpcmNsZS5lbnRyaWVzKCkpIHtcclxuICAgICAgICAgICAgaWYgKGlkICE9PSAoc3RhcnROb2RlIGFzIEdyYXBoTm9kZSkuaWQgJiYgaWQgIT09IChnb2FsTm9kZSBhcyBHcmFwaE5vZGUpLmlkKSB7XHJcbiAgICAgICAgICAgICAgICBjaXJjbGUuc2V0U3R5bGUoe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcnMuZGVmYXVsdFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChwYXRoTGluZSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICBwYXRoTGluZS5yZW1vdmUoKTtcclxuICAgICAgICAgICAgcGF0aExpbmUgPSBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgc2hvd09ubHkoY2hvb3NlU2NyZWVuKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2hlY2tTZWFyY2hCdXR0b24oKSB7XHJcbiAgICAgICAgc2VhcmNoQnV0dG9uLmRpc2FibGVkID0gIShzdGFydE5vZGUgJiYgZ29hbE5vZGUgJiYgc2VhcmNoRnVuY3Rpb24pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dPbmx5KGVsZW06IEhUTUxFbGVtZW50KSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHNpZGViYXJJdGVtcykge1xyXG4gICAgICAgICAgICBoaWRlRWxlbShpdGVtKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc2hvd0VsZW0oZWxlbSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd0VsZW0oZWxlbTogSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICBlbGVtLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBoaWRlRWxlbShlbGVtOiBIVE1MRWxlbWVudCkge1xyXG4gICAgICAgIGVsZW0uc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgIH1cclxuXHJcbn0pKCk7Il19