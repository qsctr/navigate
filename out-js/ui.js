'use strict';
onerror = alert;
navigator.geolocation.getCurrentPosition(function (pos) { return init(pos.coords.latitude, pos.coords.longitude); }, function () { return init(25.116035, 121.529946); } // fallback to TAS
);
function init(lat, lng) {
    var qs = document.querySelector.bind(document);
    var introScreen = qs('#intro-screen');
    var queryButton = qs('#query-button');
    var queryingScreen = qs('#querying-screen');
    var queryState = qs('#query-state');
    var chooseScreen = qs('#choose-screen');
    var startNodeIdElem = qs('#start-node-id');
    var goalNodeIdElem = qs('#goal-node-id');
    var searchButton = qs('#search-button');
    var resultsScreen = qs('#results-screen');
    var searchProgress = qs('#search-progress');
    var searchState = qs('#search-state');
    var map = L.map('map', {
        center: [lat, lng],
        zoom: 17,
        minZoom: 12
    });
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 21,
        maxNativeZoom: 19
    }).addTo(map);
    showElem(introScreen);
    queryButton.addEventListener('click', function () {
        hideElem(introScreen);
        showElem(queryingScreen);
        queryState.textContent = 'Querying Overpass API...';
        var bounds = map.getBounds();
        var query = "\n            [out:json];\n            way [highway] (\n                " + bounds.getSouth() + ",\n                " + bounds.getWest() + ",\n                " + bounds.getNorth() + ",\n                " + bounds.getEast() + "\n            );\n            out geom;\n        ";
        fetch('https://overpass-api.de/api/interpreter?data=' + query)
            .then(function (res) { return res.json(); })
            .then(function (data) {
            queryState.textContent = 'Creating nodes...';
            var nodes = overpassToGraphNodes(data);
            var startNode;
            var goalNode;
            var searchFunction;
            var defaultCircleStyle = {
                radius: 6,
                stroke: false,
                fillOpacity: 0.7
            };
            var nodeIdToCircle = new Map();
            var _loop_1 = function(node) {
                nodeIdToCircle.set(node.id, L.circle(node, defaultCircleStyle).bindPopup(function (circle) {
                    var elem = document.createElement('div');
                    var id = document.createElement('div');
                    id.textContent = node.id.toString();
                    elem.appendChild(id);
                    var startLink = document.createElement('a');
                    startLink.href = '#';
                    startLink.textContent = 'Set as start';
                    startLink.addEventListener('click', function () {
                        if (node === goalNode) {
                            return;
                        }
                        if (startNode !== undefined) {
                            nodeIdToCircle.get(startNode.id)
                                .setStyle(defaultCircleStyle);
                        }
                        startNode = node;
                        startNodeIdElem.textContent = startNode.id.toString();
                        checkSearchButton();
                        circle.closePopup();
                        circle.setStyle(Object.assign({
                            color: 'red'
                        }, defaultCircleStyle));
                    });
                    elem.appendChild(startLink);
                    elem.appendChild(document.createElement('br'));
                    var goalLink = document.createElement('a');
                    goalLink.href = '#';
                    goalLink.textContent = 'Set as goal';
                    goalLink.addEventListener('click', function () {
                        if (node === startNode) {
                            return;
                        }
                        if (goalNode !== undefined) {
                            nodeIdToCircle.get(goalNode.id)
                                .setStyle(defaultCircleStyle);
                        }
                        goalNode = node;
                        goalNodeIdElem.textContent = goalNode.id.toString();
                        checkSearchButton();
                        circle.closePopup();
                        circle.setStyle(Object.assign({
                            color: 'green'
                        }, defaultCircleStyle));
                    });
                    elem.appendChild(goalLink);
                    return elem;
                }).addTo(map));
            };
            for (var _i = 0, nodes_1 = nodes; _i < nodes_1.length; _i++) {
                var node = nodes_1[_i];
                _loop_1(node);
            }
            var radioToFunction = {
                'uniform-cost-radio': uniformCostSearch,
                'greedy-radio': greedySearch,
                'a-star-radio': aStarSearch
            };
            var _loop_2 = function(id) {
                document.querySelector('#' + id).addEventListener('click', function () {
                    searchFunction = radioToFunction[id];
                    checkSearchButton();
                });
            };
            for (var id in radioToFunction) {
                _loop_2(id);
            }
            queryState.textContent = '';
            hideElem(queryingScreen);
            showElem(chooseScreen);
            console.log(nodes.length + ' nodes created');
            function checkSearchButton() {
                searchButton.disabled = !(startNode && goalNode && searchFunction);
            }
            searchButton.addEventListener('click', function () {
                hideElem(chooseScreen);
                showElem(resultsScreen);
                searchProgress.classList.add('mdl-progress__indeterminate');
                searchState.textContent = 'Searching...';
                var res = searchFunction(startNode, goalNode);
                searchProgress.classList.remove('mdl-progress__indeterminate');
                if (res === null) {
                    searchState.textContent = 'Path not found';
                }
                else {
                    searchState.textContent = "Path found, " + res.expanded.length + " nodes expanded, path is " + res.path.length + " nodes long";
                    for (var _i = 0, _a = res.expanded; _i < _a.length; _i++) {
                        var expanded = _a[_i];
                        nodeIdToCircle.get(expanded.id)
                            .setStyle(Object.assign({
                            color: 'darkblue'
                        }, defaultCircleStyle));
                    }
                    L.polyline(res.path, {
                        weight: 8,
                        color: 'darkblue'
                    }).addTo(map);
                    console.log(res);
                }
            });
        });
    });
    function showElem(elem) {
        elem.style.display = 'block';
    }
    function hideElem(elem) {
        elem.style.display = 'none';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMtdHMvdWkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsT0FBTyxHQUFHLEtBQUssQ0FBQztBQUVoQixTQUFTLENBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUNwQyxVQUFBLEdBQUcsSUFBSSxPQUFBLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUEvQyxDQUErQyxFQUN0RCxjQUFNLE9BQUEsSUFBSSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsRUFBM0IsQ0FBMkIsQ0FBQyxrQkFBa0I7Q0FDdkQsQ0FBQztBQUVGLGNBQWMsR0FBVyxFQUFFLEdBQVc7SUFDbEMsSUFBTSxFQUFFLEdBQWtDLFFBQVEsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2hGLElBQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQyxlQUFlLENBQWdCLENBQUM7SUFDdkQsSUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ3hDLElBQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBZ0IsQ0FBQztJQUM3RCxJQUFNLFVBQVUsR0FBRyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDdEMsSUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFDLGdCQUFnQixDQUFnQixDQUFDO0lBQ3pELElBQU0sZUFBZSxHQUFHLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzdDLElBQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUMzQyxJQUFNLFlBQVksR0FBRyxFQUFFLENBQUMsZ0JBQWdCLENBQXNCLENBQUM7SUFDL0QsSUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFnQixDQUFDO0lBQzNELElBQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQzlDLElBQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUN4QyxJQUFNLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRTtRQUNyQixNQUFNLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDO1FBQ2xCLElBQUksRUFBRSxFQUFFO1FBQ1IsT0FBTyxFQUFFLEVBQUU7S0FDZCxDQUFDLENBQUM7SUFDSCxDQUFDLENBQUMsU0FBUyxDQUFDLHlDQUF5QyxFQUFFO1FBQ25ELFdBQVcsRUFBRSwwRUFBMEU7UUFDdkYsT0FBTyxFQUFFLEVBQUU7UUFDWCxhQUFhLEVBQUUsRUFBRTtLQUNwQixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3RCLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUU7UUFDbEMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3RCLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUN6QixVQUFVLENBQUMsV0FBVyxHQUFHLDBCQUEwQixDQUFDO1FBQ3BELElBQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUMvQixJQUFNLEtBQUssR0FBRyw2RUFHSixNQUFNLENBQUMsUUFBUSxFQUFFLDJCQUNqQixNQUFNLENBQUMsT0FBTyxFQUFFLDJCQUNoQixNQUFNLENBQUMsUUFBUSxFQUFFLDJCQUNqQixNQUFNLENBQUMsT0FBTyxFQUFFLHNEQUd6QixDQUFDO1FBQ0YsS0FBSyxDQUFDLCtDQUErQyxHQUFHLEtBQUssQ0FBQzthQUN6RCxJQUFJLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQVYsQ0FBVSxDQUFDO2FBQ3ZCLElBQUksQ0FBQyxVQUFDLElBQWtCO1lBQ3JCLFVBQVUsQ0FBQyxXQUFXLEdBQUcsbUJBQW1CLENBQUM7WUFDN0MsSUFBTSxLQUFLLEdBQUcsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekMsSUFBSSxTQUFvQixDQUFDO1lBQ3pCLElBQUksUUFBbUIsQ0FBQztZQUN4QixJQUFJLGNBQThCLENBQUM7WUFDbkMsSUFBTSxrQkFBa0IsR0FBRztnQkFDdkIsTUFBTSxFQUFFLENBQUM7Z0JBQ1QsTUFBTSxFQUFFLEtBQUs7Z0JBQ2IsV0FBVyxFQUFFLEdBQUc7YUFDbkIsQ0FBQztZQUNGLElBQU0sY0FBYyxHQUFHLElBQUksR0FBRyxFQUFvQixDQUFDO1lBQ25EO2dCQUNJLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFDdEIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQSxNQUFNO29CQUMvQyxJQUFNLElBQUksR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUMzQyxJQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUN6QyxFQUFFLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUM7b0JBQ3BDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQ3JCLElBQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQzlDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO29CQUNyQixTQUFTLENBQUMsV0FBVyxHQUFHLGNBQWMsQ0FBQztvQkFDdkMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRTt3QkFDaEMsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7NEJBQ3BCLE1BQU0sQ0FBQzt3QkFDWCxDQUFDO3dCQUNELEVBQUUsQ0FBQyxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDOzRCQUN6QixjQUFjLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQWM7aUNBQ3pDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO3dCQUN0QyxDQUFDO3dCQUNELFNBQVMsR0FBRyxJQUFJLENBQUM7d0JBQ2pCLGVBQWUsQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQzt3QkFDdEQsaUJBQWlCLEVBQUUsQ0FBQzt3QkFDcEIsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO3dCQUNuQixNQUFtQixDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDOzRCQUN4QyxLQUFLLEVBQUUsS0FBSzt5QkFDZixFQUFFLGtCQUFrQixDQUFDLENBQUMsQ0FBQztvQkFDNUIsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQy9DLElBQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQzdDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO29CQUNwQixRQUFRLENBQUMsV0FBVyxHQUFHLGFBQWEsQ0FBQztvQkFDckMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRTt3QkFDL0IsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7NEJBQ3JCLE1BQU0sQ0FBQzt3QkFDWCxDQUFDO3dCQUNELEVBQUUsQ0FBQyxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDOzRCQUN4QixjQUFjLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQWM7aUNBQ3hDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO3dCQUN0QyxDQUFDO3dCQUNELFFBQVEsR0FBRyxJQUFJLENBQUM7d0JBQ2hCLGNBQWMsQ0FBQyxXQUFXLEdBQUcsUUFBUSxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQzt3QkFDcEQsaUJBQWlCLEVBQUUsQ0FBQzt3QkFDcEIsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO3dCQUNuQixNQUFtQixDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDOzRCQUN4QyxLQUFLLEVBQUUsT0FBTzt5QkFDakIsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7b0JBQzVCLENBQUMsQ0FBQyxDQUFDO29CQUNILElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBQzNCLE1BQU0sQ0FBQyxJQUFJLENBQUM7Z0JBQ2hCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDOztZQWpEdkIsR0FBRyxDQUFDLENBQWUsVUFBSyxFQUFMLGVBQUssRUFBTCxtQkFBSyxFQUFMLElBQUssQ0FBQztnQkFBcEIsSUFBTSxJQUFJLGNBQUE7O2FBa0RkO1lBQ0QsSUFBTSxlQUFlLEdBQXFDO2dCQUN0RCxvQkFBb0IsRUFBRSxpQkFBaUI7Z0JBQ3ZDLGNBQWMsRUFBRSxZQUFZO2dCQUM1QixjQUFjLEVBQUUsV0FBVzthQUM5QixDQUFDO1lBQ0Y7Z0JBQ0ksUUFBUSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFO29CQUN2RCxjQUFjLEdBQUcsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO29CQUNyQyxpQkFBaUIsRUFBRSxDQUFDO2dCQUN4QixDQUFDLENBQUMsQ0FBQzs7WUFKUCxHQUFHLENBQUMsQ0FBQyxJQUFNLEVBQUUsSUFBSSxlQUFlLENBQUM7O2FBS2hDO1lBQ0QsVUFBVSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7WUFDNUIsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3pCLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUN2QixPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsZ0JBQWdCLENBQUMsQ0FBQztZQUM3QztnQkFDSSxZQUFZLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxTQUFTLElBQUksUUFBUSxJQUFJLGNBQWMsQ0FBQyxDQUFDO1lBQ3ZFLENBQUM7WUFDRCxZQUFZLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFO2dCQUNuQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQ3ZCLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztnQkFDeEIsY0FBYyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsNkJBQTZCLENBQUMsQ0FBQztnQkFDNUQsV0FBVyxDQUFDLFdBQVcsR0FBRyxjQUFjLENBQUM7Z0JBQ3pDLElBQU0sR0FBRyxHQUFHLGNBQWMsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7Z0JBQ2hELGNBQWMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLDZCQUE2QixDQUFDLENBQUM7Z0JBQy9ELEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO29CQUNmLFdBQVcsQ0FBQyxXQUFXLEdBQUcsZ0JBQWdCLENBQUM7Z0JBQy9DLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ0osV0FBVyxDQUFDLFdBQVcsR0FBRyxpQkFBZSxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0saUNBQTRCLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxnQkFBYSxDQUFDO29CQUNySCxHQUFHLENBQUMsQ0FBbUIsVUFBWSxFQUFaLEtBQUEsR0FBRyxDQUFDLFFBQVEsRUFBWixjQUFZLEVBQVosSUFBWSxDQUFDO3dCQUEvQixJQUFNLFFBQVEsU0FBQTt3QkFDZCxjQUFjLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQWM7NkJBQzVDLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDOzRCQUNwQixLQUFLLEVBQUUsVUFBVTt5QkFDcEIsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLENBQUE7cUJBQzFCO29CQUNELENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRTt3QkFDakIsTUFBTSxFQUFFLENBQUM7d0JBQ1QsS0FBSyxFQUFFLFVBQVU7cUJBQ3BCLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDckIsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDLENBQUMsQ0FBQztJQUNILGtCQUFrQixJQUFpQjtRQUMvQixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDakMsQ0FBQztJQUNELGtCQUFrQixJQUFpQjtRQUMvQixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7SUFDaEMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5vbmVycm9yID0gYWxlcnQ7XHJcblxyXG5uYXZpZ2F0b3IuZ2VvbG9jYXRpb24uZ2V0Q3VycmVudFBvc2l0aW9uKFxyXG4gICAgcG9zID0+IGluaXQocG9zLmNvb3Jkcy5sYXRpdHVkZSwgcG9zLmNvb3Jkcy5sb25naXR1ZGUpLFxyXG4gICAgKCkgPT4gaW5pdCgyNS4xMTYwMzUsIDEyMS41Mjk5NDYpIC8vIGZhbGxiYWNrIHRvIFRBU1xyXG4pO1xyXG5cclxuZnVuY3Rpb24gaW5pdChsYXQ6IG51bWJlciwgbG5nOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IHFzOiB0eXBlb2YgZG9jdW1lbnQucXVlcnlTZWxlY3RvciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IuYmluZChkb2N1bWVudCk7XHJcbiAgICBjb25zdCBpbnRyb1NjcmVlbiA9IHFzKCcjaW50cm8tc2NyZWVuJykgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICBjb25zdCBxdWVyeUJ1dHRvbiA9IHFzKCcjcXVlcnktYnV0dG9uJyk7XHJcbiAgICBjb25zdCBxdWVyeWluZ1NjcmVlbiA9IHFzKCcjcXVlcnlpbmctc2NyZWVuJykgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICBjb25zdCBxdWVyeVN0YXRlID0gcXMoJyNxdWVyeS1zdGF0ZScpO1xyXG4gICAgY29uc3QgY2hvb3NlU2NyZWVuID0gcXMoJyNjaG9vc2Utc2NyZWVuJykgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICBjb25zdCBzdGFydE5vZGVJZEVsZW0gPSBxcygnI3N0YXJ0LW5vZGUtaWQnKTtcclxuICAgIGNvbnN0IGdvYWxOb2RlSWRFbGVtID0gcXMoJyNnb2FsLW5vZGUtaWQnKTtcclxuICAgIGNvbnN0IHNlYXJjaEJ1dHRvbiA9IHFzKCcjc2VhcmNoLWJ1dHRvbicpIGFzIEhUTUxCdXR0b25FbGVtZW50O1xyXG4gICAgY29uc3QgcmVzdWx0c1NjcmVlbiA9IHFzKCcjcmVzdWx0cy1zY3JlZW4nKSBhcyBIVE1MRWxlbWVudDtcclxuICAgIGNvbnN0IHNlYXJjaFByb2dyZXNzID0gcXMoJyNzZWFyY2gtcHJvZ3Jlc3MnKTtcclxuICAgIGNvbnN0IHNlYXJjaFN0YXRlID0gcXMoJyNzZWFyY2gtc3RhdGUnKTtcclxuICAgIGNvbnN0IG1hcCA9IEwubWFwKCdtYXAnLCB7XHJcbiAgICAgICAgY2VudGVyOiBbbGF0LCBsbmddLFxyXG4gICAgICAgIHpvb206IDE3LFxyXG4gICAgICAgIG1pblpvb206IDEyXHJcbiAgICB9KTtcclxuICAgIEwudGlsZUxheWVyKCdodHRwOi8ve3N9LnRpbGUub3NtLm9yZy97en0ve3h9L3t5fS5wbmcnLCB7XHJcbiAgICAgICAgYXR0cmlidXRpb246ICcmY29weTsgPGEgaHJlZj1cImh0dHA6Ly9vc20ub3JnL2NvcHlyaWdodFwiPk9wZW5TdHJlZXRNYXA8L2E+IGNvbnRyaWJ1dG9ycycsXHJcbiAgICAgICAgbWF4Wm9vbTogMjEsXHJcbiAgICAgICAgbWF4TmF0aXZlWm9vbTogMTlcclxuICAgIH0pLmFkZFRvKG1hcCk7XHJcbiAgICBzaG93RWxlbShpbnRyb1NjcmVlbik7XHJcbiAgICBxdWVyeUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcclxuICAgICAgICBoaWRlRWxlbShpbnRyb1NjcmVlbik7XHJcbiAgICAgICAgc2hvd0VsZW0ocXVlcnlpbmdTY3JlZW4pO1xyXG4gICAgICAgIHF1ZXJ5U3RhdGUudGV4dENvbnRlbnQgPSAnUXVlcnlpbmcgT3ZlcnBhc3MgQVBJLi4uJztcclxuICAgICAgICBjb25zdCBib3VuZHMgPSBtYXAuZ2V0Qm91bmRzKCk7XHJcbiAgICAgICAgY29uc3QgcXVlcnkgPSBgXHJcbiAgICAgICAgICAgIFtvdXQ6anNvbl07XHJcbiAgICAgICAgICAgIHdheSBbaGlnaHdheV0gKFxyXG4gICAgICAgICAgICAgICAgJHtib3VuZHMuZ2V0U291dGgoKX0sXHJcbiAgICAgICAgICAgICAgICAke2JvdW5kcy5nZXRXZXN0KCl9LFxyXG4gICAgICAgICAgICAgICAgJHtib3VuZHMuZ2V0Tm9ydGgoKX0sXHJcbiAgICAgICAgICAgICAgICAke2JvdW5kcy5nZXRFYXN0KCl9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIG91dCBnZW9tO1xyXG4gICAgICAgIGA7XHJcbiAgICAgICAgZmV0Y2goJ2h0dHBzOi8vb3ZlcnBhc3MtYXBpLmRlL2FwaS9pbnRlcnByZXRlcj9kYXRhPScgKyBxdWVyeSlcclxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpXHJcbiAgICAgICAgICAgIC50aGVuKChkYXRhOiBPdmVycGFzc0pTT04pID0+IHtcclxuICAgICAgICAgICAgICAgIHF1ZXJ5U3RhdGUudGV4dENvbnRlbnQgPSAnQ3JlYXRpbmcgbm9kZXMuLi4nO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZXMgPSBvdmVycGFzc1RvR3JhcGhOb2RlcyhkYXRhKTtcclxuICAgICAgICAgICAgICAgIGxldCBzdGFydE5vZGU6IEdyYXBoTm9kZTtcclxuICAgICAgICAgICAgICAgIGxldCBnb2FsTm9kZTogR3JhcGhOb2RlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHNlYXJjaEZ1bmN0aW9uOiBTZWFyY2hGdW5jdGlvbjtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRDaXJjbGVTdHlsZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICByYWRpdXM6IDYsXHJcbiAgICAgICAgICAgICAgICAgICAgc3Ryb2tlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICBmaWxsT3BhY2l0eTogMC43XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZUlkVG9DaXJjbGUgPSBuZXcgTWFwPG51bWJlciwgTC5DaXJjbGU+KCk7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBub2RlSWRUb0NpcmNsZS5zZXQobm9kZS5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgTC5jaXJjbGUobm9kZSwgZGVmYXVsdENpcmNsZVN0eWxlKS5iaW5kUG9wdXAoY2lyY2xlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZC50ZXh0Q29udGVudCA9IG5vZGUuaWQudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uYXBwZW5kQ2hpbGQoaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnRMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMaW5rLmhyZWYgPSAnIyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExpbmsudGV4dENvbnRlbnQgPSAnU2V0IGFzIHN0YXJ0JztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGluay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZ29hbE5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnROb2RlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5vZGVJZFRvQ2lyY2xlLmdldChzdGFydE5vZGUuaWQpIGFzIEwuQ2lyY2xlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnNldFN0eWxlKGRlZmF1bHRDaXJjbGVTdHlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0Tm9kZSA9IG5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnROb2RlSWRFbGVtLnRleHRDb250ZW50ID0gc3RhcnROb2RlLmlkLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tTZWFyY2hCdXR0b24oKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaXJjbGUuY2xvc2VQb3B1cCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChjaXJjbGUgYXMgTC5DaXJjbGUpLnNldFN0eWxlKE9iamVjdC5hc3NpZ24oe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogJ3JlZCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBkZWZhdWx0Q2lyY2xlU3R5bGUpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5hcHBlbmRDaGlsZChzdGFydExpbmspO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdicicpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ29hbExpbmsuaHJlZiA9ICcjJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdvYWxMaW5rLnRleHRDb250ZW50ID0gJ1NldCBhcyBnb2FsJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdvYWxMaW5rLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBzdGFydE5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ29hbE5vZGUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAobm9kZUlkVG9DaXJjbGUuZ2V0KGdvYWxOb2RlLmlkKSBhcyBMLkNpcmNsZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zZXRTdHlsZShkZWZhdWx0Q2lyY2xlU3R5bGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnb2FsTm9kZSA9IG5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ29hbE5vZGVJZEVsZW0udGV4dENvbnRlbnQgPSBnb2FsTm9kZS5pZC50b1N0cmluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrU2VhcmNoQnV0dG9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2lyY2xlLmNsb3NlUG9wdXAoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoY2lyY2xlIGFzIEwuQ2lyY2xlKS5zZXRTdHlsZShPYmplY3QuYXNzaWduKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6ICdncmVlbidcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBkZWZhdWx0Q2lyY2xlU3R5bGUpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS5hcHBlbmRDaGlsZChnb2FsTGluayk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSkuYWRkVG8obWFwKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCByYWRpb1RvRnVuY3Rpb246IHsgW2lkOiBzdHJpbmddOiBTZWFyY2hGdW5jdGlvbiB9ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICd1bmlmb3JtLWNvc3QtcmFkaW8nOiB1bmlmb3JtQ29zdFNlYXJjaCxcclxuICAgICAgICAgICAgICAgICAgICAnZ3JlZWR5LXJhZGlvJzogZ3JlZWR5U2VhcmNoLFxyXG4gICAgICAgICAgICAgICAgICAgICdhLXN0YXItcmFkaW8nOiBhU3RhclNlYXJjaFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaWQgaW4gcmFkaW9Ub0Z1bmN0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignIycgKyBpZCkuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaEZ1bmN0aW9uID0gcmFkaW9Ub0Z1bmN0aW9uW2lkXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tTZWFyY2hCdXR0b24oKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHF1ZXJ5U3RhdGUudGV4dENvbnRlbnQgPSAnJztcclxuICAgICAgICAgICAgICAgIGhpZGVFbGVtKHF1ZXJ5aW5nU2NyZWVuKTtcclxuICAgICAgICAgICAgICAgIHNob3dFbGVtKGNob29zZVNjcmVlbik7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhub2Rlcy5sZW5ndGggKyAnIG5vZGVzIGNyZWF0ZWQnKTtcclxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrU2VhcmNoQnV0dG9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlYXJjaEJ1dHRvbi5kaXNhYmxlZCA9ICEoc3RhcnROb2RlICYmIGdvYWxOb2RlICYmIHNlYXJjaEZ1bmN0aW9uKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHNlYXJjaEJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBoaWRlRWxlbShjaG9vc2VTY3JlZW4pO1xyXG4gICAgICAgICAgICAgICAgICAgIHNob3dFbGVtKHJlc3VsdHNTY3JlZW4pO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlYXJjaFByb2dyZXNzLmNsYXNzTGlzdC5hZGQoJ21kbC1wcm9ncmVzc19faW5kZXRlcm1pbmF0ZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlYXJjaFN0YXRlLnRleHRDb250ZW50ID0gJ1NlYXJjaGluZy4uLic7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzID0gc2VhcmNoRnVuY3Rpb24oc3RhcnROb2RlLCBnb2FsTm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoUHJvZ3Jlc3MuY2xhc3NMaXN0LnJlbW92ZSgnbWRsLXByb2dyZXNzX19pbmRldGVybWluYXRlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcyA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hTdGF0ZS50ZXh0Q29udGVudCA9ICdQYXRoIG5vdCBmb3VuZCc7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VhcmNoU3RhdGUudGV4dENvbnRlbnQgPSBgUGF0aCBmb3VuZCwgJHtyZXMuZXhwYW5kZWQubGVuZ3RofSBub2RlcyBleHBhbmRlZCwgcGF0aCBpcyAke3Jlcy5wYXRoLmxlbmd0aH0gbm9kZXMgbG9uZ2A7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZXhwYW5kZWQgb2YgcmVzLmV4cGFuZGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAobm9kZUlkVG9DaXJjbGUuZ2V0KGV4cGFuZGVkLmlkKSBhcyBMLkNpcmNsZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zZXRTdHlsZShPYmplY3QuYXNzaWduKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogJ2RhcmtibHVlJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgZGVmYXVsdENpcmNsZVN0eWxlKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBMLnBvbHlsaW5lKHJlcy5wYXRoLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3ZWlnaHQ6IDgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogJ2RhcmtibHVlJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KS5hZGRUbyhtYXApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgZnVuY3Rpb24gc2hvd0VsZW0oZWxlbTogSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICBlbGVtLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gaGlkZUVsZW0oZWxlbTogSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICBlbGVtLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XHJcbiAgICB9XHJcbn0iXX0=