'use strict';
onerror = alert;
navigator.geolocation.getCurrentPosition(function (pos) { return init(pos.coords.latitude, pos.coords.longitude); }, function () { return init(25.116035, 121.529946); } // fallback to TAS
);
function init(lat, lng) {
    var qs = document.querySelector.bind(document);
    var introScreen = qs('#intro-screen');
    var queryButton = qs('#query-button');
    var queryingScreen = qs('#querying-screen');
    var queryState = qs('#query-state');
    var chooseScreen = qs('#choose-screen');
    var startNodeIdElem = qs('#start-node-id');
    var goalNodeIdElem = qs('#goal-node-id');
    var searchButton = qs('#search-button');
    var resultsScreen = qs('#results-screen');
    var searchProgress = qs('#search-progress');
    var searchState = qs('#search-state');
    var map = L.map('map', {
        center: [lat, lng],
        zoom: 17,
        minZoom: 14
    });
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 21,
        maxNativeZoom: 19
    }).addTo(map);
    showElem(introScreen);
    queryButton.addEventListener('click', function () {
        hideElem(introScreen);
        showElem(queryingScreen);
        queryState.textContent = 'Querying Overpass API...';
        var bounds = map.getBounds();
        var query = "\n            [out:json];\n            way [highway] (\n                " + bounds.getSouth() + ",\n                " + bounds.getWest() + ",\n                " + bounds.getNorth() + ",\n                " + bounds.getEast() + "\n            );\n            out geom;\n        ";
        fetch('http://overpass-api.de/api/interpreter?data=' + query)
            .then(function (res) { return res.json(); })
            .then(function (data) {
            queryState.textContent = 'Creating nodes...';
            var nodes = overpassToGraphNodes(data);
            var startNode;
            var goalNode;
            var searchFunction;
            var defaultCircleStyle = {
                radius: 6,
                stroke: false,
                fillOpacity: 0.7
            };
            var nodeIdToCircle = new Map(nodes.map(function (node) { return [
                node.id,
                L.circle(node, defaultCircleStyle).bindPopup(function (circle) {
                    var elem = document.createElement('div');
                    var id = document.createElement('div');
                    id.textContent = node.id.toString();
                    elem.appendChild(id);
                    var startLink = document.createElement('a');
                    startLink.href = '#';
                    startLink.textContent = 'Set as start';
                    startLink.addEventListener('click', function () {
                        if (node === goalNode) {
                            return;
                        }
                        if (startNode !== undefined) {
                            nodeIdToCircle.get(startNode.id)
                                .setStyle(defaultCircleStyle);
                        }
                        startNode = node;
                        startNodeIdElem.textContent = startNode.id.toString();
                        checkSearchButton();
                        circle.closePopup();
                        circle.setStyle(Object.assign({
                            color: 'red'
                        }, defaultCircleStyle));
                    });
                    elem.appendChild(startLink);
                    elem.appendChild(document.createElement('br'));
                    var goalLink = document.createElement('a');
                    goalLink.href = '#';
                    goalLink.textContent = 'Set as goal';
                    goalLink.addEventListener('click', function () {
                        if (node === startNode) {
                            return;
                        }
                        if (goalNode !== undefined) {
                            nodeIdToCircle.get(goalNode.id)
                                .setStyle(defaultCircleStyle);
                        }
                        goalNode = node;
                        goalNodeIdElem.textContent = goalNode.id.toString();
                        checkSearchButton();
                        circle.closePopup();
                        circle.setStyle(Object.assign({
                            color: 'green'
                        }, defaultCircleStyle));
                    });
                    elem.appendChild(goalLink);
                    return elem;
                }).addTo(map)
            ]; }));
            var radioToFunction = {
                'uniform-cost-radio': uniformCostSearch,
                'greedy-radio': greedySearch,
                'a-star-radio': aStarSearch
            };
            var _loop_1 = function(id) {
                document.querySelector('#' + id).addEventListener('click', function () {
                    searchFunction = radioToFunction[id];
                    checkSearchButton();
                });
            };
            for (var id in radioToFunction) {
                _loop_1(id);
            }
            queryState.textContent = '';
            hideElem(queryingScreen);
            showElem(chooseScreen);
            console.log(nodes.length + ' nodes created');
            function checkSearchButton() {
                searchButton.disabled = !(startNode && goalNode && searchFunction);
            }
            searchButton.addEventListener('click', function () {
                hideElem(chooseScreen);
                showElem(resultsScreen);
                searchProgress.classList.add('mdl-progress__indeterminate');
                searchState.textContent = 'Searching...';
                var res = searchFunction(startNode, goalNode);
                searchProgress.classList.remove('mdl-progress__indeterminate');
                if (res === null) {
                    searchState.textContent = 'Path not found';
                }
                else {
                    searchState.textContent = "Path found, " + res.expanded.length + " nodes expanded, path is " + res.path.length + " nodes long";
                    for (var _i = 0, _a = res.expanded; _i < _a.length; _i++) {
                        var expanded = _a[_i];
                        nodeIdToCircle.get(expanded.id)
                            .setStyle(Object.assign({
                            color: 'darkblue'
                        }, defaultCircleStyle));
                    }
                    L.polyline(res.path, {
                        weight: 8,
                        color: 'darkblue'
                    }).addTo(map);
                    console.log(res);
                }
            });
        });
    });
    function showElem(elem) {
        elem.style.display = 'block';
    }
    function hideElem(elem) {
        elem.style.display = 'none';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMtdHMvdWkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsT0FBTyxHQUFHLEtBQUssQ0FBQztBQUVoQixTQUFTLENBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUNwQyxVQUFBLEdBQUcsSUFBSSxPQUFBLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUEvQyxDQUErQyxFQUN0RCxjQUFNLE9BQUEsSUFBSSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsRUFBM0IsQ0FBMkIsQ0FBQyxrQkFBa0I7Q0FDdkQsQ0FBQztBQUVGLGNBQWMsR0FBVyxFQUFFLEdBQVc7SUFDbEMsSUFBTSxFQUFFLEdBQWtDLFFBQVEsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2hGLElBQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQyxlQUFlLENBQWdCLENBQUM7SUFDdkQsSUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ3hDLElBQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBZ0IsQ0FBQztJQUM3RCxJQUFNLFVBQVUsR0FBRyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDdEMsSUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFDLGdCQUFnQixDQUFnQixDQUFDO0lBQ3pELElBQU0sZUFBZSxHQUFHLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzdDLElBQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUMzQyxJQUFNLFlBQVksR0FBRyxFQUFFLENBQUMsZ0JBQWdCLENBQXNCLENBQUM7SUFDL0QsSUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFnQixDQUFDO0lBQzNELElBQU0sY0FBYyxHQUFH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VTtxQkFDcEIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDZCxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNyQixDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNYLENBQUMsQ0FBQyxDQUFDO0lBQ0gsa0JBQWtCLElBQWlCO1FBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUNqQyxDQUFDO0lBQ0Qsa0JBQWtCLElBQWlCO1FBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUNoQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbm9uZXJyb3IgPSBhbGVydDtcclxuXHJcbm5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oXHJcbiAgICBwb3MgPT4gaW5pdChwb3MuY29vcmRzLmxhdGl0dWRlLCBwb3MuY29vcmRzLmxvbmdpdHVkZSksXHJcbiAgICAoKSA9PiBpbml0KDI1LjExNjAzNSwgMTIxLjUyOTk0NikgLy8gZmFsbGJhY2sgdG8gVEFTXHJcbik7XHJcblxyXG5mdW5jdGlvbiBpbml0KGxhdDogbnVtYmVyLCBsbmc6IG51bWJlcikge1xyXG4gICAgY29uc3QgcXM6IHR5cGVvZiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvci5iaW5kKGRvY3VtZW50KTtcclxuICAgIGNvbnN0IGludHJvU2NyZWVuID0gcXMoJyNpbnRyby1zY3JlZW4nKSBhcyBIVE1MRWxlbWVudDtcclxuICAgIGNvbnN0IHF1ZXJ5QnV0dG9uID0gcXMoJyNxdWVyeS1idXR0b24nKTtcclxuICAgIGNvbnN0IHF1ZXJ5aW5nU2NyZWVuID0gcXMoJyNxdWVyeWluZy1zY3JlZW4nKSBhcyBIVE1MRWxlbWVudDtcclxuICAgIGNvbnN0IHF1ZXJ5U3RhdGUgPSBxcygnI3F1ZXJ5LXN0YXRlJyk7XHJcbiAgICBjb25zdCBjaG9vc2VTY3JlZW4gPSBxcygnI2Nob29zZS1zY3JlZW4nKSBhcyBIVE1MRWxlbWVudDtcclxuICAgIGNvbnN0IHN0YXJ0Tm9kZUlkRWxlbSA9IHFzKCcjc3RhcnQtbm9kZS1pZCcpO1xyXG4gICAgY29uc3QgZ29hbE5vZGVJZEVsZW0gPSBxcygnI2dvYWwtbm9kZS1pZCcpO1xyXG4gICAgY29uc3Qgc2VhcmNoQnV0dG9uID0gcXMoJyNzZWFyY2gtYnV0dG9uJykgYXMgSFRNTEJ1dHRvbkVsZW1lbnQ7XHJcbiAgICBjb25zdCByZXN1bHRzU2NyZWVuID0gcXMoJyNyZXN1bHRzLXNjcmVlbicpIGFzIEhUTUxFbGVtZW50O1xyXG4gICAgY29uc3Qgc2VhcmNoUHJvZ3Jlc3MgPSBxcygnI3NlYXJjaC1wcm9ncmVzcycpO1xyXG4gICAgY29uc3Qgc2VhcmNoU3RhdGUgPSBxcygnI3NlYXJjaC1zdGF0ZScpO1xyXG4gICAgY29uc3QgbWFwID0gTC5tYXAoJ21hcCcsIHtcclxuICAgICAgICBjZW50ZXI6IFtsYXQsIGxuZ10sXHJcbiAgICAgICAgem9vbTogMTcsXHJcbiAgICAgICAgbWluWm9vbTogMTRcclxuICAgIH0pO1xyXG4gICAgTC50aWxlTGF5ZXIoJ2h0dHA6Ly97c30udGlsZS5vc20ub3JnL3t6fS97eH0ve3l9LnBuZycsIHtcclxuICAgICAgICBhdHRyaWJ1dGlvbjogJyZjb3B5OyA8YSBocmVmPVwiaHR0cDovL29zbS5vcmcvY29weXJpZ2h0XCI+T3BlblN0cmVldE1hcDwvYT4gY29udHJpYnV0b3JzJyxcclxuICAgICAgICBtYXhab29tOiAyMSxcclxuICAgICAgICBtYXhOYXRpdmVab29tOiAxOVxyXG4gICAgfSkuYWRkVG8obWFwKTtcclxuICAgIHNob3dFbGVtKGludHJvU2NyZWVuKTtcclxuICAgIHF1ZXJ5QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgIGhpZGVFbGVtKGludHJvU2NyZWVuKTtcclxuICAgICAgICBzaG93RWxlbShxdWVyeWluZ1NjcmVlbik7XHJcbiAgICAgICAgcXVlcnlTdGF0ZS50ZXh0Q29udGVudCA9ICdRdWVyeWluZyBPdmVycGFzcyBBUEkuLi4nO1xyXG4gICAgICAgIGNvbnN0IGJvdW5kcyA9IG1hcC5nZXRCb3VuZHMoKTtcclxuICAgICAgICBjb25zdCBxdWVyeSA9IGBcclxuICAgICAgICAgICAgW291dDpqc29uXTtcclxuICAgICAgICAgICAgd2F5IFtoaWdod2F5XSAoXHJcbiAgICAgICAgICAgICAgICAke2JvdW5kcy5nZXRTb3V0aCgpfSxcclxuICAgICAgICAgICAgICAgICR7Ym91bmRzLmdldFdlc3QoKX0sXHJcbiAgICAgICAgICAgICAgICAke2JvdW5kcy5nZXROb3J0aCgpfSxcclxuICAgICAgICAgICAgICAgICR7Ym91bmRzLmdldEVhc3QoKX1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgb3V0IGdlb207XHJcbiAgICAgICAgYDtcclxuICAgICAgICBmZXRjaCgnaHR0cDovL292ZXJwYXNzLWFwaS5kZS9hcGkvaW50ZXJwcmV0ZXI/ZGF0YT0nICsgcXVlcnkpXHJcbiAgICAgICAgICAgIC50aGVuKHJlcyA9PiByZXMuanNvbigpKVxyXG4gICAgICAgICAgICAudGhlbigoZGF0YTogT3ZlcnBhc3NKU09OKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBxdWVyeVN0YXRlLnRleHRDb250ZW50ID0gJ0NyZWF0aW5nIG5vZGVzLi4uJztcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGVzID0gb3ZlcnBhc3NUb0dyYXBoTm9kZXMoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBsZXQgc3RhcnROb2RlOiBHcmFwaE5vZGU7XHJcbiAgICAgICAgICAgICAgICBsZXQgZ29hbE5vZGU6IEdyYXBoTm9kZTtcclxuICAgICAgICAgICAgICAgIGxldCBzZWFyY2hGdW5jdGlvbjogU2VhcmNoRnVuY3Rpb247XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0Q2lyY2xlU3R5bGUgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmFkaXVzOiA2LFxyXG4gICAgICAgICAgICAgICAgICAgIHN0cm9rZTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgZmlsbE9wYWNpdHk6IDAuN1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGVJZFRvQ2lyY2xlID0gbmV3IE1hcDxudW1iZXIsIEwuQ2lyY2xlPihub2Rlcy5tYXAobm9kZSA9PiBbXHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5pZCxcclxuICAgICAgICAgICAgICAgICAgICBMLmNpcmNsZShub2RlLCBkZWZhdWx0Q2lyY2xlU3R5bGUpLmJpbmRQb3B1cChjaXJjbGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkLnRleHRDb250ZW50ID0gbm9kZS5pZC50b1N0cmluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmFwcGVuZENoaWxkKGlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnRMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydExpbmsuaHJlZiA9ICcjJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMaW5rLnRleHRDb250ZW50ID0gJ1NldCBhcyBzdGFydCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGluay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBnb2FsTm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGFydE5vZGUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChub2RlSWRUb0NpcmNsZS5nZXQoc3RhcnROb2RlLmlkKSBhcyBMLkNpcmNsZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnNldFN0eWxlKGRlZmF1bHRDaXJjbGVTdHlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydE5vZGUgPSBub2RlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnROb2RlSWRFbGVtLnRleHRDb250ZW50ID0gc3RhcnROb2RlLmlkLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja1NlYXJjaEJ1dHRvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2lyY2xlLmNsb3NlUG9wdXAoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChjaXJjbGUgYXMgTC5DaXJjbGUpLnNldFN0eWxlKE9iamVjdC5hc3NpZ24oe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAncmVkJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgZGVmYXVsdENpcmNsZVN0eWxlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmFwcGVuZENoaWxkKHN0YXJ0TGluayk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnInKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdvYWxMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBnb2FsTGluay5ocmVmID0gJyMnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBnb2FsTGluay50ZXh0Q29udGVudCA9ICdTZXQgYXMgZ29hbCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGdvYWxMaW5rLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHN0YXJ0Tm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnb2FsTm9kZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5vZGVJZFRvQ2lyY2xlLmdldChnb2FsTm9kZS5pZCkgYXMgTC5DaXJjbGUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zZXRTdHlsZShkZWZhdWx0Q2lyY2xlU3R5bGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ29hbE5vZGUgPSBub2RlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ29hbE5vZGVJZEVsZW0udGV4dENvbnRlbnQgPSBnb2FsTm9kZS5pZC50b1N0cmluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tTZWFyY2hCdXR0b24oKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNpcmNsZS5jbG9zZVBvcHVwKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoY2lyY2xlIGFzIEwuQ2lyY2xlKS5zZXRTdHlsZShPYmplY3QuYXNzaWduKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogJ2dyZWVuJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgZGVmYXVsdENpcmNsZVN0eWxlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbGVtLmFwcGVuZENoaWxkKGdvYWxMaW5rKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW07XHJcbiAgICAgICAgICAgICAgICAgICAgfSkuYWRkVG8obWFwKVxyXG4gICAgICAgICAgICAgICAgXSBhcyBbbnVtYmVyLCBMLkNpcmNsZV0pKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJhZGlvVG9GdW5jdGlvbjogeyBbaWQ6IHN0cmluZ106IFNlYXJjaEZ1bmN0aW9uIH0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ3VuaWZvcm0tY29zdC1yYWRpbyc6IHVuaWZvcm1Db3N0U2VhcmNoLFxyXG4gICAgICAgICAgICAgICAgICAgICdncmVlZHktcmFkaW8nOiBncmVlZHlTZWFyY2gsXHJcbiAgICAgICAgICAgICAgICAgICAgJ2Etc3Rhci1yYWRpbyc6IGFTdGFyU2VhcmNoXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBpZCBpbiByYWRpb1RvRnVuY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjJyArIGlkKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VhcmNoRnVuY3Rpb24gPSByYWRpb1RvRnVuY3Rpb25baWRdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGVja1NlYXJjaEJ1dHRvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcXVlcnlTdGF0ZS50ZXh0Q29udGVudCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgaGlkZUVsZW0ocXVlcnlpbmdTY3JlZW4pO1xyXG4gICAgICAgICAgICAgICAgc2hvd0VsZW0oY2hvb3NlU2NyZWVuKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG5vZGVzLmxlbmd0aCArICcgbm9kZXMgY3JlYXRlZCcpO1xyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gY2hlY2tTZWFyY2hCdXR0b24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoQnV0dG9uLmRpc2FibGVkID0gIShzdGFydE5vZGUgJiYgZ29hbE5vZGUgJiYgc2VhcmNoRnVuY3Rpb24pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgc2VhcmNoQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGhpZGVFbGVtKGNob29zZVNjcmVlbik7XHJcbiAgICAgICAgICAgICAgICAgICAgc2hvd0VsZW0ocmVzdWx0c1NjcmVlbik7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoUHJvZ3Jlc3MuY2xhc3NMaXN0LmFkZCgnbWRsLXByb2dyZXNzX19pbmRldGVybWluYXRlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoU3RhdGUudGV4dENvbnRlbnQgPSAnU2VhcmNoaW5nLi4uJztcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXMgPSBzZWFyY2hGdW5jdGlvbihzdGFydE5vZGUsIGdvYWxOb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICBzZWFyY2hQcm9ncmVzcy5jbGFzc0xpc3QucmVtb3ZlKCdtZGwtcHJvZ3Jlc3NfX2luZGV0ZXJtaW5hdGUnKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaFN0YXRlLnRleHRDb250ZW50ID0gJ1BhdGggbm90IGZvdW5kJztcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hTdGF0ZS50ZXh0Q29udGVudCA9IGBQYXRoIGZvdW5kLCAke3Jlcy5leHBhbmRlZC5sZW5ndGh9IG5vZGVzIGV4cGFuZGVkLCBwYXRoIGlzICR7cmVzLnBhdGgubGVuZ3RofSBub2RlcyBsb25nYDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBleHBhbmRlZCBvZiByZXMuZXhwYW5kZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChub2RlSWRUb0NpcmNsZS5nZXQoZXhwYW5kZWQuaWQpIGFzIEwuQ2lyY2xlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnNldFN0eWxlKE9iamVjdC5hc3NpZ24oe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAnZGFya2JsdWUnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBkZWZhdWx0Q2lyY2xlU3R5bGUpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIEwucG9seWxpbmUocmVzLnBhdGgsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdlaWdodDogOCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAnZGFya2JsdWUnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLmFkZFRvKG1hcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICBmdW5jdGlvbiBzaG93RWxlbShlbGVtOiBIVE1MRWxlbWVudCkge1xyXG4gICAgICAgIGVsZW0uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBoaWRlRWxlbShlbGVtOiBIVE1MRWxlbWVudCkge1xyXG4gICAgICAgIGVsZW0uc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgIH1cclxufSJdfQ==